rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- 共通ユーティリティ ----
    function isSignedIn() {
      return request.auth != null;
    }

    function isMember(projectId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    function role(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid)).data.role;
    }

    function isAdmin(projectId) {
      return isSignedIn() && role(projectId) == 'admin';
    }

    function isEditor(projectId) {
      return isSignedIn() && (role(projectId) in ['admin', 'member']);
    }

    function isValidRole(newRole) {
      return newRole in ['admin', 'member', 'viewer'];
    }

    // ---- InsurePath 共通ユーティリティ ----
    // 現在のユーザープロファイルを取得（同じパスへの get はキャッシュされる）
    function currentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // ユーザープロファイルからロールを取得
    function getUserRole() {
      return currentUser().data.role;
    }

    // ユーザーが指定事業所に所属しているかチェック
    function belongsToOffice(officeId) {
      return isSignedIn() && currentUser().data.officeId == officeId;
    }

    // 管理者または人事担当者かチェック
    function isAdminOrHr(officeId) {
      return belongsToOffice(officeId) && getUserRole() in ['admin', 'hr'];
    }

    // 管理者かチェック
    function isInsureAdmin(officeId) {
      return belongsToOffice(officeId) && getUserRole() == 'admin';
    }

    // 一般従業員かチェック
    function isInsureEmployee(officeId) {
      return belongsToOffice(officeId) && getUserRole() == 'employee';
    }

    // 自分の従業員レコードに紐づいているかチェック
    function isOwnEmployee(officeId, employeeId) {
      return isSignedIn() && belongsToOffice(officeId) && currentUser().data.employeeId == employeeId;
    }

    match /projects/{projectId} {

      // ===== Invites（招待リンク）=====
      function validInvite(d) {
        return d.keys().hasOnly([
          'email',
          'role',
          'createdBy',
          'createdAt',
          'status',
          'expiresAt',
          'acceptedBy',
          'acceptedAt'
        ])
        && (d.email is string) && d.email.size() > 3 && d.email.size() <= 320
        && isValidRole(d.role)
        && (d.createdBy is string) && d.createdBy == request.auth.uid
        && (d.createdAt is timestamp)
        && (!('status' in d) || (d.status is string && d.status.size() <= 30))
        && (!('expiresAt' in d) || (d.expiresAt is timestamp))
        && (!('acceptedBy' in d) || (d.acceptedBy is string))
        && (!('acceptedAt' in d) || (d.acceptedAt is timestamp));
      }

      match /invites/{inviteId} {
        allow read: if
          // 1. プロジェクト管理者
          isAdmin(projectId)
          // 2. ログイン済み & メール一致（従来ロジック）
          || (isSignedIn()
              && request.auth.token.email != null
              && resource.data.email == request.auth.token.email)
          // 3. 未使用招待はトークンを知っていれば閲覧可
          || (!('acceptedBy' in resource.data));

        allow create: if isAdmin(projectId)
          && validInvite(request.resource.data);

        allow update: if isAdmin(projectId)
          && request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(['status','expiresAt','role','acceptedBy','acceptedAt'])
          && (!('role' in request.resource.data) || isValidRole(request.resource.data.role));

        allow delete: if isAdmin(projectId);
      }

      // ===== Analytics =====
      match /analytics/currentSummary {
        allow read: if isMember(projectId);
        allow create, update, delete: if false;
      }

      match /analyticsPerUser/{uid} {
        allow read: if isMember(projectId)
          && request.auth != null
          && request.auth.uid == uid;
        allow create, update, delete: if false;
      }

      // ===== Reports =====
      match /reports/{reportId} {
        allow read: if isMember(projectId);
        allow create, update, delete: if isEditor(projectId);
      }

      // プロジェクト直下の読み取りはメンバーのみ
      allow read: if isMember(projectId);

      // 監査ログ
      match /auditLogs/{logId} {
        allow read: if isMember(projectId);
        allow create, update, delete: if false;
      }

      // 新規プロジェクト作成
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly(['meta'])
        && request.resource.data.meta.keys().hasOnly(['name','createdBy','createdAt'])
        && request.resource.data.meta.createdBy == request.auth.uid;

      // 既存プロジェクトの更新/削除は admin のみ
      allow update, delete: if isAdmin(projectId);

      // ===== members =====
      match /members/{uid} {
        allow read: if isMember(projectId);

        // 本人が displayName / email / updatedAt を更新
        // ★ updatedAt を許可するように修正
        allow update: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.diff(resource.data).changedKeys()
               .hasOnly(['displayName','email','updatedAt'])
          && (!('displayName' in request.resource.data)
              || (
                   (request.resource.data.displayName is string)
                   && request.resource.data.displayName.size() > 0
                   && request.resource.data.displayName.size() <= 120
                 ))
          && (!('email' in request.resource.data)
              || (
                   request.auth.token.email != null
                   && request.resource.data.email == request.auth.token.email
                 ))
          && (!('updatedAt' in request.resource.data)
              || (request.resource.data.updatedAt is timestamp));

        // admin 作成（自己作成 or admin招待）
        allow create: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.role == 'admin'
          && (
            request.resource.data.keys().hasOnly(['role','joinedAt','displayName','email'])
            ||
            (
              request.resource.data.keys().hasOnly(['role','joinedAt','inviteId','invitedBy','displayName','email'])
              && request.auth.token.email != null
              && exists(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId))
              && get(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId)).data.email
                   == request.auth.token.email
            )
          );

        // member/viewer の招待登録
        allow create: if isSignedIn()
          && request.auth.uid == uid
          && (request.resource.data.role in ['member','viewer'])
          && request.resource.data.keys().hasOnly(['role','joinedAt','inviteId','invitedBy','displayName','email'])
          && request.auth.token.email != null
          && exists(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId))
          && get(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId)).data.email
               == request.auth.token.email;

        // 管理者によるロール変更（role のみ）
        allow update: if isAdmin(projectId)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['role'])
          && isValidRole(request.resource.data.role);

        // 削除
        allow delete: if isAdmin(projectId);
      }

      // --- カンバン列 ---
      function isValidBoardColumn(col) {
        return col.keys().hasOnly([
          'columnId','title','order','categoryHint','progressHint'
        ])
        && (!('title' in col) || ((col.title is string) && col.title.size() >= 0 && col.title.size() <= 120))
        && (!('order' in col) || (col.order is int || col.order is float))
        && (!('categoryHint' in col) || (col.categoryHint in ['not_started','in_progress','done']))
        && (!('progressHint' in col) || ((col.progressHint is int || col.progressHint is float) && col.progressHint >= 0 && col.progressHint <= 100))
        && (!('columnId' in col) || (col.columnId is string && col.columnId.size() > 0 && col.columnId.size() <= 200));
      }

      match /boardColumns/{columnId} {
        allow read: if isMember(projectId);
        allow create, update: if isEditor(projectId) && isValidBoardColumn(request.resource.data);
        allow delete: if isEditor(projectId);
      }

            // ===== Problems / Issues / Tasks =====
      match /problems/{problemId} {
        allow read: if isMember(projectId);

        function validProblemDef(def, oldDef) {
          return def.keys().hasOnly(['phenomenon','cause','solution','goal','updatedAt','updatedBy'])
            && (def.phenomenon is string)
            && def.phenomenon.matches('^[\\s\\S]{1,1000}$')
            && (def.goal is string)
            && def.goal.matches('^[\\s\\S]{1,500}$')
            && (!('cause' in def) || (def.cause is string && def.cause.matches('^[\\s\\S]{0,1000}$')))
            && (!('solution' in def) || (def.solution is string && def.solution.matches('^[\\s\\S]{0,1000}$')))
            // updatedBy の扱い:
            // - 作成時: 自分の uid であれば OK
            // - 更新時: 変更されていなければ OK
            //           変更するなら自分の uid であること
            && (
              !('updatedBy' in def)
              || def.updatedBy == request.auth.uid
              || (
                   oldDef != null
                   && 'updatedBy' in oldDef
                   && def.updatedBy == oldDef.updatedBy
                 )
            );
        }

        function validAttachmentData(d) {
          return d.keys().hasOnly(['name','contentType','size','storagePath','downloadURL','createdAt','updatedAt','createdBy'])
            && (d.name is string) && d.name.size() > 0 && d.name.size() <= 200
            && (d.contentType is string) && d.contentType.size() > 0
            && ((d.size is int) || (d.size is float)) && d.size >= 0 && d.size <= 20 * 1024 * 1024
            && (d.storagePath is string) && d.storagePath.size() > 0
            && (d.downloadURL is string) && d.downloadURL.size() > 0
            && (d.createdBy is string) && d.createdBy == request.auth.uid;
        }

        allow create, update: if isEditor(projectId)
          && (
            !('problemDef' in request.resource.data)
            || validProblemDef(
                 request.resource.data.problemDef,
                 ('problemDef' in resource.data) ? resource.data.problemDef : null
               )
          );

        allow delete: if isEditor(projectId);

        match /attachments/{attId} {
          allow read: if isMember(projectId);

          allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);

          allow update: if isSignedIn()
            && resource.data.createdBy == request.auth.uid
            && request.resource.data.keys().hasOnly(['name','updatedAt'])
            && (request.resource.data.name is string)
            && request.resource.data.name.size() > 0
            && request.resource.data.name.size() <= 200;

          allow delete: if isSignedIn()
            && resource.data.createdBy == request.auth.uid;
        }

        match /comments/{commentId} {
          allow read: if isMember(projectId);
          allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;

          allow update: if isSignedIn()
            && resource.data.authorId == request.auth.uid
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['body','updatedAt'])
            && (request.resource.data.body is string)
            && request.resource.data.body.size() > 0
            && request.resource.data.body.size() <= 2000;

          allow delete: if isSignedIn()
            && resource.data.authorId == request.auth.uid;
        }

        // ===== Issues =====
        match /issues/{issueId} {
          allow read: if isMember(projectId);
          allow create, update: if isEditor(projectId);
          allow delete: if isEditor(projectId);

          match /attachments/{attId} {
            allow read: if isMember(projectId);
            allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);

            allow update: if isSignedIn()
              && resource.data.createdBy == request.auth.uid
              && request.resource.data.keys().hasOnly(['name','updatedAt'])
              && (request.resource.data.name is string)
              && request.resource.data.name.size() > 0
              && request.resource.data.name.size() <= 200;

            allow delete: if isSignedIn()
              && resource.data.createdBy == request.auth.uid;
          }

          match /comments/{commentId} {
            allow read: if isMember(projectId);
            allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;
            allow update, delete: if (
              (request.auth != null && resource.data.authorId == request.auth.uid)
              || isAdmin(projectId)
            );
          }

                    match /tasks/{taskId} {
            allow read: if isMember(projectId);

            // 非Admin Editor が新規作成する場合:
            // assignees / assigneeLocks を送らない or 空ならOK
            function canEditorCreateWithoutAssignments(d) {
              return (
                !('assignees' in d)
                || (
                  (d.assignees is list && d.assignees.size() == 0)
                  || (d.assignees is map && d.assignees.keys().size() == 0)
                )
              ) && (
                !('assigneeLocks' in d)
                || (
                  (d.assigneeLocks is list && d.assigneeLocks.size() == 0)
                  || (d.assigneeLocks is map && d.assigneeLocks.keys().size() == 0)
                )
              );
            }

            // 作成:
            // Admin: assignees / assigneeLocks 自由
            // 非Admin Editor: assignees / assigneeLocks を実質設定不可（空のみ）
            allow create: if
              isAdmin(projectId)
              || (
                isEditor(projectId)
                && canEditorCreateWithoutAssignments(request.resource.data)
              );

            // 更新:
            // Admin: 自由
            // 非Admin Editor: assignees / assigneeLocks を変更しない場合のみ
            allow update: if
              isAdmin(projectId)
              || (
                isEditor(projectId)
                && !request.resource.data
                    .diff(resource.data)
                    .changedKeys()
                    .hasAny(['assignees', 'assigneeLocks'])
              );

            // 削除: Editor 以上
            allow delete: if isEditor(projectId);

            match /attachments/{attId} {
              allow read: if isMember(projectId);
              allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);

              allow update: if isSignedIn()
                && resource.data.createdBy == request.auth.uid
                && request.resource.data.keys().hasOnly(['name','updatedAt'])
                && (request.resource.data.name is string)
                && request.resource.data.name.size() > 0
                && request.resource.data.name.size() <= 200;

              allow delete: if isSignedIn()
                && resource.data.createdBy == request.auth.uid;
            }

            match /comments/{commentId} {
              allow read: if isMember(projectId);
              allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;
              allow update, delete: if (
                (request.auth != null && resource.data.authorId == request.auth.uid)
                || isAdmin(projectId)
              );
            }
          }

        }
      }
    } // end /projects/{projectId}

    // ---- users コレクション ----
    // InsurePath: users/{uid} にユーザープロファイルを保存
    // ProblemPath: users/{uid}/... のサブコレクションを利用
    match /users/{uid} {
    function validInsureUserProfile(d) {
      return d.keys().hasOnly([
        'id',
        'officeId',
        'role',
        'displayName',
        'email',
        'createdAt',
        'updatedAt',
        'employeeId',        // ★追加
      ])
      && (d.id is string && d.id == uid)
      && (!('officeId' in d) || (d.officeId is string))
      && (!('role' in d) || (d.role is string && d.role.size() > 0 && d.role.size() <= 30))
      && (d.displayName is string
          && d.displayName.size() > 0
          && d.displayName.size() <= 120)
      && (d.email is string
          && d.email.size() > 3
          && d.email.size() <= 320)
      && (d.createdAt is string)
      && (d.updatedAt is string)
      // ★ employeeId がある場合だけ型チェック
      && (!('employeeId' in d)
          || (d.employeeId is string
              && d.employeeId.size() > 0
              && d.employeeId.size() <= 200));
    }

      // 自分の users/{uid} だけ読み書きできる (InsurePath 用)
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow create, update: if
        isSignedIn()
        && request.auth.uid == uid
        && validInsureUserProfile(request.resource.data);

      // 削除はとりあえず禁止（必要ならあとで検討）
      allow delete: if false;

      // ===== ここから下は ProblemPath 用のサブコレクション =====

      // 通知設定: users/{uid}/notifyPrefs/app
      function isValidNotifyPrefs(d) {
        return d.keys().hasOnly([
          'instantComment',
          'instantFile',
          'dueReminderMode',
          'dueReminderHour',
        ])
        && (!('instantComment' in d) || (d.instantComment is bool))
        && (!('instantFile' in d)   || (d.instantFile is bool))
        && (!('dueReminderMode' in d)
            || (d.dueReminderMode in ['none', '1d', '7d', '1d7d']))
        && (!('dueReminderHour' in d)
            || (d.dueReminderHour is int
                && d.dueReminderHour >= 0
                && d.dueReminderHour <= 23));
      }

      match /notifyPrefs/{docId} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create, update: if
          isSignedIn()
          && request.auth.uid == uid
          && isValidNotifyPrefs(request.resource.data);
        allow delete: if false;
      }

      match /memberships/{projectId} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create: if isSignedIn() && request.auth.uid == uid;
        allow update: if isSignedIn() && (
          request.auth.uid == uid
          || (
            isAdmin(projectId)
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['role'])
            && isValidRole(request.resource.data.role)
          )
        );
        allow delete: if isSignedIn()
          && (request.auth.uid == uid || isAdmin(projectId));
      }

      match /fcmTokens/{token} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create, update, delete: if isSignedIn() && request.auth.uid == uid;
      }

      match /fcmStatus/{docId} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create, update: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.keys().hasOnly(['enabled','lastTokenSavedAt','lastError']);
        allow delete: if false;
      }
    }

    // ---- InsurePath 用: offices 以下 ----
    match /offices/{officeId} {
      // 事業所情報へのアクセス制御
      function validOfficeExtendedFields(data) {
        return (!('officeSymbol' in data) || data.officeSymbol == null || data.officeSymbol is string)
          && (!('officeNumber' in data) || data.officeNumber == null || data.officeNumber is string)
          && (!('officeCityCode' in data) || data.officeCityCode == null || data.officeCityCode is string)
          && (!('officePostalCode' in data) || data.officePostalCode == null || (data.officePostalCode is string && data.officePostalCode.matches('^[0-9]{7}$')))
          && (!('officePhone' in data) || data.officePhone == null || data.officePhone is string)
          && (!('officeOwnerName' in data) || data.officeOwnerName == null || data.officeOwnerName is string);
      }

      allow read: if belongsToOffice(officeId);
      allow create: if isSignedIn() && validOfficeExtendedFields(request.resource.data);
      allow update, delete: if isInsureAdmin(officeId) && validOfficeExtendedFields(request.resource.data);

      // 従業員情報
      match /employees/{employeeId} {
        function validEmployeeExtendedFields(data) {
          return (!('employeeCodeInOffice' in data) || data.employeeCodeInOffice == null || data.employeeCodeInOffice is string)
            && (!('sex' in data) || data.sex == null || data.sex in ['male', 'female', 'other'])
            && (!('postalCode' in data) || data.postalCode == null || (data.postalCode is string && data.postalCode.matches('^[0-9]{7}$')))
            && (!('addressKana' in data) || data.addressKana == null || data.addressKana is string)
            // TODO: 現在は平文12桁前提。将来、本当に暗号化する場合はこのチェックを変更する必要がある
            && (!('myNumber' in data) || data.myNumber == null || (data.myNumber is string && data.myNumber.size() == 12 && data.myNumber.matches('^[0-9]{12}$')));
        }

        allow read: if belongsToOffice(officeId) && (isAdminOrHr(officeId) || isOwnEmployee(officeId, employeeId));
        allow create, update: if isAdminOrHr(officeId) && validEmployeeExtendedFields(request.resource.data);
        allow delete: if isAdminOrHr(officeId);

        // 扶養家族情報
        match /dependents/{dependentId} {
          function validDependentExtendedFields(data) {
            return (!('kana' in data) || data.kana == null || data.kana is string)
              && (!('sex' in data) || data.sex == null || data.sex in ['male', 'female', 'other'])
              && (!('postalCode' in data) || data.postalCode == null || (data.postalCode is string && data.postalCode.matches('^[0-9]{7}$')))
              && (!('address' in data) || data.address == null || data.address is string)
              && (!('cohabitationFlag' in data) || data.cohabitationFlag == null || data.cohabitationFlag in ['cohabiting', 'separate'])
              // TODO: 現在は平文12桁前提。将来、本当に暗号化する場合はこのチェックを変更する必要がある
              && (!('myNumber' in data) || data.myNumber == null || (data.myNumber is string && data.myNumber.size() == 12 && data.myNumber.matches('^[0-9]{12}$')));
          }

          allow read: if belongsToOffice(officeId) && isAdminOrHr(officeId);
          allow create, update: if belongsToOffice(officeId) && isAdminOrHr(officeId) && validDependentExtendedFields(request.resource.data);
          allow delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
        }

        match /standardRewardHistories/{historyId} {
          allow read: if belongsToOffice(officeId) && isAdminOrHr(officeId);
          allow create, update, delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
        }
      }

      // 月次保険料
      match /monthlyPremiums/{docId} {
        allow read: if belongsToOffice(officeId) && (isAdminOrHr(officeId) || (isInsureEmployee(officeId) && resource.data.employeeId == currentUser().data.employeeId));
        allow create, update, delete: if isAdminOrHr(officeId);
      }

      // 賞与保険料
      match /bonusPremiums/{docId} {
        allow read: if belongsToOffice(officeId) && (isAdminOrHr(officeId) || (isInsureEmployee(officeId) && resource.data.employeeId == currentUser().data.employeeId));
        allow create, update, delete: if isAdminOrHr(officeId);
      }

      // 社会保険料納付状況
      match /payments/{paymentId} {
        function isValidSocialInsurancePaymentBase(data) {
          return data.id == paymentId
            && data.officeId == officeId
            && data.targetYearMonth is string
            && data.plannedHealthCompany is int && data.plannedHealthCompany >= 0
            && data.plannedCareCompany is int && data.plannedCareCompany >= 0
            && data.plannedPensionCompany is int && data.plannedPensionCompany >= 0
            && data.plannedTotalCompany is int && data.plannedTotalCompany >= 0
            && data.paymentStatus in ['unpaid', 'paid', 'partially_paid', 'not_required']
            && (!('paymentMethod' in data) || data.paymentMethod == null || data.paymentMethod in ['bank_transfer', 'account_transfer', 'cash', 'other'])
            && (!('paymentMethodNote' in data) || data.paymentMethodNote == null || data.paymentMethodNote is string)
            && (!('paymentDate' in data) || data.paymentDate == null || data.paymentDate is string)
            && (!('memo' in data) || data.memo == null || data.memo is string)
            && data.createdAt is string
            && data.updatedAt is string
            && data.createdByUserId is string
            && data.updatedByUserId is string;
        }

        function isValidPaidStatus(data) {
          return data.paymentStatus != 'paid' || (
            data.paymentDate != null
              && data.paymentDate is string
              && data.actualTotalCompany != null
              && data.actualTotalCompany is int
              && data.actualTotalCompany >= 0
          );
        }

        function isValidAmountFields(data) {
          return (
            (!('actualHealthCompany' in data) || data.actualHealthCompany == null || (data.actualHealthCompany is int && data.actualHealthCompany >= 0))
              && (!('actualCareCompany' in data) || data.actualCareCompany == null || (data.actualCareCompany is int && data.actualCareCompany >= 0))
              && (!('actualPensionCompany' in data) || data.actualPensionCompany == null || (data.actualPensionCompany is int && data.actualPensionCompany >= 0))
              && (!('actualTotalCompany' in data) || data.actualTotalCompany == null || (data.actualTotalCompany is int && data.actualTotalCompany >= 0))
          );
        }

        allow read: if belongsToOffice(officeId) && isAdminOrHr(officeId);

        allow create: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && request.resource.data.keys().hasOnly([
            'id', 'officeId', 'targetYearMonth',
            'plannedHealthCompany', 'plannedCareCompany', 'plannedPensionCompany', 'plannedTotalCompany',
            'actualHealthCompany', 'actualCareCompany', 'actualPensionCompany', 'actualTotalCompany',
            'paymentStatus', 'paymentMethod', 'paymentMethodNote', 'paymentDate',
            'memo', 'createdAt', 'updatedAt', 'createdByUserId', 'updatedByUserId'
          ])
          && isValidSocialInsurancePaymentBase(request.resource.data)
          && isValidAmountFields(request.resource.data)
          && isValidPaidStatus(request.resource.data)
          && request.resource.data.createdByUserId == request.auth.uid
          && request.resource.data.updatedByUserId == request.auth.uid;

        allow update: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && isValidSocialInsurancePaymentBase(request.resource.data)
          && isValidAmountFields(request.resource.data)
          && isValidPaidStatus(request.resource.data)
          && request.resource.data.id == resource.data.id
          && request.resource.data.officeId == resource.data.officeId
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.createdByUserId == resource.data.createdByUserId
          && request.resource.data.updatedByUserId == request.auth.uid;

        allow delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
      }

      // 社会保険手続き履歴
      match /procedures/{procedureId} {
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && resource.data.employeeId == currentUser().data.employeeId)
        );

        allow create, update, delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
      }

      // 扶養状況確認結果
      match /dependentReviews/{reviewId} {
        // 共通バリデーション: DependentReview の基本フィールド
        function isValidDependentReviewBase(data) {
          return data.id == reviewId
            && data.officeId == officeId
            && data.employeeId is string
            && data.dependentId is string
            && data.reviewDate is string
            && data.result in ['continued', 'to_be_removed', 'needs_review']
            && data.createdAt is string
            && data.updatedAt is string
            && data.createdByUserId is string
            && data.updatedByUserId is string;
        }

        // 閲覧: admin/hr は全件、employee は現時点では閲覧不可（将来拡張用プレースホルダー）
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && false)
        );

        // 作成: admin/hr のみ、フィールドと officeId / userId を厳密チェック
        allow create: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && request.resource.data.keys().hasOnly([
            'id', 'officeId', 'employeeId', 'dependentId',
            'reviewDate', 'result', 'reviewedBy', 'note',
            'sessionId', 'createdAt', 'updatedAt',
            'createdByUserId', 'updatedByUserId'
          ])
          && isValidDependentReviewBase(request.resource.data)
          && request.resource.data.createdByUserId == request.auth.uid
          && request.resource.data.updatedByUserId == request.auth.uid;

        // 更新: admin/hr のみ、変更可能なフィールドを限定
        allow update: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && isValidDependentReviewBase(request.resource.data)
          // id / officeId / createdAt / createdByUserId は更新不可
          && request.resource.data.id == resource.data.id
          && request.resource.data.officeId == resource.data.officeId
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.createdByUserId == resource.data.createdByUserId
          // 変更されうるキーを限定
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'employeeId', 'dependentId', 'reviewDate', 'result',
            'reviewedBy', 'note', 'sessionId', 'updatedAt', 'updatedByUserId'
          ])
          && request.resource.data.updatedByUserId == request.auth.uid;

        // 削除: admin/hr のみ
        allow delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
      }

      // 扶養状況確認セッション
      match /dependentReviewSessions/{sessionId} {
        // 共通バリデーション: DependentReviewSession の基本フィールド
        function isValidDependentReviewSessionBase(data) {
          return data.id == sessionId
            && data.officeId == officeId
            && data.referenceDate is string
            && data.checkedAt is string
            && data.createdAt is string
            && data.updatedAt is string
            && data.createdByUserId is string
            && data.updatedByUserId is string;
        }

        // 閲覧: admin/hr は全件、employee は現時点では閲覧不可（将来拡張用プレースホルダー）
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && false)
        );

        // 作成: admin/hr のみ、フィールドと officeId / userId を厳密チェック
        allow create: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && request.resource.data.keys().hasOnly([
            'id', 'officeId', 'referenceDate', 'checkedAt',
            'checkedBy', 'note', 'createdAt', 'updatedAt',
            'createdByUserId', 'updatedByUserId'
          ])
          && isValidDependentReviewSessionBase(request.resource.data)
          && request.resource.data.createdByUserId == request.auth.uid
          && request.resource.data.updatedByUserId == request.auth.uid;

        // 更新: admin/hr のみ、変更可能なフィールドを限定
        allow update: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && isValidDependentReviewSessionBase(request.resource.data)
          // id / officeId / createdAt / createdByUserId は更新不可
          && request.resource.data.id == resource.data.id
          && request.resource.data.officeId == resource.data.officeId
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.createdByUserId == resource.data.createdByUserId
          // 変更されうるキーを限定
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'referenceDate', 'checkedAt', 'checkedBy', 'note',
            'updatedAt', 'updatedByUserId'
          ])
          && request.resource.data.updatedByUserId == request.auth.uid;

        // 削除: admin/hr のみ
        allow delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
      }

      // 変更申請
      // 書類管理（Phase3-10）
      match /documents/{documentId} {
        // 共通バリデーション: DocumentAttachment の基本フィールド
        function isValidDocumentAttachmentBase(data) {
          return data.id == documentId
            && data.officeId == officeId
            && data.employeeId is string
            && data.category in ['identity', 'residence', 'incomeProof', 'studentProof', 'relationshipProof', 'otherInsurance', 'medical', 'caregiving', 'procedureOther', 'other']
            && data.title is string && data.title.size() > 0 && data.title.size() <= 200
            && data.storagePath is string
            && data.fileName is string
            && data.fileSize is int && data.fileSize > 0
            && data.mimeType is string
            && data.uploadedAt is string
            && data.uploadedByUserId is string
            && data.uploadedByDisplayName is string
            && data.source in ['adminUpload', 'employeeUploadViaRequest']
            && data.createdAt is string
            && data.updatedAt is string;
        }
        
        // 閲覧: admin/hr は全件、employee は自分の employeeId に紐づくもののみ
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && resource.data.employeeId == currentUser().data.employeeId)
        );
        
        // 作成: admin/hr は全件、employee は自分の employeeId に紐づくもののみ（リクエスト経由）
        allow create: if belongsToOffice(officeId) && (
          (
            isAdminOrHr(officeId)
              && request.resource.data.keys().hasOnly([
                'id', 'officeId', 'employeeId', 'dependentId',
                'category', 'title', 'note', 'storagePath', 'fileName', 'fileSize', 'mimeType',
                'uploadedAt', 'uploadedByUserId', 'uploadedByDisplayName',
                'source', 'requestId',
                'expiresAt', 'isExpired',
                'createdAt', 'updatedAt'
              ])
              && isValidDocumentAttachmentBase(request.resource.data)
              && request.resource.data.uploadedByUserId == request.auth.uid
          )
          || (
            isInsureEmployee(officeId)
              && request.resource.data.employeeId == currentUser().data.employeeId
              && request.resource.data.source == 'employeeUploadViaRequest'
              && request.resource.data.requestId is string
              && request.resource.data.uploadedByUserId == request.auth.uid
              && isValidDocumentAttachmentBase(request.resource.data)
          )
        );
        
        // 更新: admin/hr のみ（メモ、有効期限の更新など）
        allow update: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'note', 'expiresAt', 'isExpired', 'updatedAt'
          ])
          && request.resource.data.id == resource.data.id
          && request.resource.data.officeId == resource.data.officeId
          && request.resource.data.employeeId == resource.data.employeeId;
        
        // 削除: admin/hr のみ
        allow delete: if belongsToOffice(officeId) && isAdminOrHr(officeId);
      }

      match /documentRequests/{requestId} {
        // 共通バリデーション: DocumentRequest の基本フィールド
        function isValidDocumentRequestBase(data) {
          return data.id == requestId
            && data.officeId == officeId
            && data.employeeId is string
            && data.category in ['identity', 'residence', 'incomeProof', 'studentProof', 'relationshipProof', 'otherInsurance', 'medical', 'caregiving', 'procedureOther', 'other']
            && data.title is string && data.title.size() > 0 && data.title.size() <= 200
            && data.status in ['pending', 'uploaded', 'cancelled']
            && data.requestedByUserId is string
            && data.requestedByDisplayName is string
            && data.createdAt is string
            && data.updatedAt is string;
        }
        
        // 閲覧: admin/hr は全件、employee は自分の employeeId に紐づくもののみ
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && resource.data.employeeId == currentUser().data.employeeId)
        );
        
        // 作成: admin/hr のみ
        allow create: if belongsToOffice(officeId)
          && isAdminOrHr(officeId)
          && request.resource.data.keys().hasOnly([
            'id', 'officeId', 'employeeId',
            'category', 'title', 'message',
            'requestedByUserId', 'requestedByDisplayName',
            'status', 'dueDate',
            'createdAt', 'updatedAt'
          ])
          && isValidDocumentRequestBase(request.resource.data)
          && request.resource.data.status == 'pending'
          && request.resource.data.requestedByUserId == request.auth.uid;
        
        // 更新: admin/hr は全件、employee は自分の employeeId に紐づく pending なもののみ（status を uploaded に更新）
        allow update: if belongsToOffice(officeId) && (
          (
            isAdminOrHr(officeId)
              && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                'status', 'resolvedAt', 'updatedAt'
              ])
              && (
                (request.resource.data.status == 'cancelled' && resource.data.status == 'pending')
                || (request.resource.data.status == 'uploaded' && resource.data.status == 'pending' && request.resource.data.resolvedAt is string)
              )
          )
          || (
            isInsureEmployee(officeId)
              && resource.data.employeeId == currentUser().data.employeeId
              && resource.data.status == 'pending'
              && request.resource.data.status == 'uploaded'
              && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'resolvedAt', 'updatedAt'])
              && request.resource.data.resolvedAt is string
          )
        );
        
        // 削除: 不可（履歴として保持）
        allow delete: if false;
      }

      match /changeRequests/{requestId} {
        allow read: if belongsToOffice(officeId) && (
          isAdminOrHr(officeId) ||
          (isInsureEmployee(officeId) && resource.data.requestedByUserId == request.auth.uid)
        );

        allow create: if belongsToOffice(officeId)
          && (isInsureEmployee(officeId) || isAdminOrHr(officeId))
          && request.resource.data.employeeId == currentUser().data.employeeId
          && request.resource.data.requestedByUserId == request.auth.uid
          && request.resource.data.keys().hasOnly([
            'id', 'officeId', 'employeeId', 'requestedByUserId',
            'field', 'currentValue', 'requestedValue', 'status',
            'requestedAt', 'decidedAt', 'decidedByUserId', 'rejectReason',
            'kind', 'targetDependentId', 'payload'
          ])
          && request.resource.data.officeId == officeId
          && request.resource.data.status == 'pending'
          && !('decidedAt' in request.resource.data)
          && !('decidedByUserId' in request.resource.data)
          && !('rejectReason' in request.resource.data);

        allow update: if belongsToOffice(officeId) && (
          (
            isAdminOrHr(officeId)
              && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'decidedAt', 'decidedByUserId', 'rejectReason'])
              && (
                (request.resource.data.status == 'approved' && resource.data.status == 'pending')
                || (
                  request.resource.data.status == 'rejected'
                  && resource.data.status == 'pending'
                  && request.resource.data.rejectReason is string
                  && request.resource.data.rejectReason.size() > 0
                )
              )
              && request.resource.data.decidedByUserId == request.auth.uid
              && request.resource.data.decidedAt is string
          )
          || (
            (isInsureEmployee(officeId) || isAdminOrHr(officeId))
              && resource.data.requestedByUserId == request.auth.uid
              && resource.data.status == 'pending'
              && request.resource.data.status == 'canceled'
              && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status'])
          )
        );

        allow delete: if false;
      }

      // 健康保険料率マスタ
      match /healthRateTables/{docId} {
        allow read: if belongsToOffice(officeId);
        allow create, update, delete: if isInsureAdmin(officeId);
      }

      // 介護保険料率マスタ
      match /careRateTables/{docId} {
        allow read: if belongsToOffice(officeId);
        allow create, update, delete: if isInsureAdmin(officeId);
      }

      // 厚生年金保険料率マスタ
      match /pensionRateTables/{docId} {
        allow read: if belongsToOffice(officeId);
        allow create, update, delete: if isInsureAdmin(officeId);
      }

      // その他のサブコレクション（将来拡張用）
      match /{subcollection}/{docId} {
        allow read: if belongsToOffice(officeId);
        allow create, update, delete: if isAdminOrHr(officeId);
      }
    }

    // ===== クラウドマスタ（システム全体で共有）=====
    // 健康保険クラウドマスタ（システム全体で共有）
    match /cloudHealthRateTables/{docId} {
      // 読み取り: 全認証ユーザーが閲覧可能
      allow read: if isSignedIn();
      
      // 作成・更新・削除: adminロールのみ（システム管理者が更新可能）
      allow create, update, delete: if isSignedIn() && getUserRole() == 'admin';
    }

    // 介護保険クラウドマスタ（システム全体で共有）
    match /cloudCareRateTables/{docId} {
      // 読み取り: 全認証ユーザーが閲覧可能
      allow read: if isSignedIn();
      
      // 作成・更新・削除: adminロールのみ（システム管理者が更新可能）
      allow create, update, delete: if isSignedIn() && getUserRole() == 'admin';
    }

    // 厚生年金クラウドマスタ（システム全体で共有）
    match /cloudPensionRateTables/{docId} {
      // 読み取り: 全認証ユーザーが閲覧可能
      allow read: if isSignedIn();
      
      // 作成・更新・削除: adminロールのみ（システム管理者が更新可能）
      allow create, update, delete: if isSignedIn() && getUserRole() == 'admin';
    }

    // TODO: テスト完了後に削除 - 旧 InsurePath offices ルール
    // match /offices/{officeId} {
    //   allow read, create, update, delete: if isSignedIn();
    //   match /{subcollection}/{docId} {
    //     allow read, create, update, delete: if isSignedIn();
    //   }
    // }

    // === collectionGroup('tasks') 用 (読み取り専用) ===
    match /{path=**}/tasks/{taskId} {
      allow read: if isMember(resource.data.projectId);
      // 書き込みは上の具体的パスでのみ許可
    }
  }
}


