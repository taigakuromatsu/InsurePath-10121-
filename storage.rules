rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ---- 共通: サインイン判定 ----
    function isSignedIn() {
      return request.auth != null;
    }

    // ---- ProblemPath 共通: オブジェクト所有者判定（metadata.createdBy を利用）----
    function isOwner() {
      return resource.metadata.createdBy == request.auth.uid;
    }

    // ===== ProblemPath: Problem attachments =====
    match /projects/{projectId}/problems/{problemId}/attachments/{fileName=**} {
      allow read: if isSignedIn();

      // create/update/delete すべて「サインイン済み かつ 自分のファイル」に限定
      allow write: if isSignedIn() && (
        // create or update: 新しいメタデータ側の createdBy が自分
        (request.resource != null && request.resource.metadata.createdBy == request.auth.uid)
        ||
        // delete: 既存オブジェクトの createdBy が自分
        (request.resource == null && isOwner())
      );
    }

    // ===== ProblemPath: Issue attachments =====
    match /projects/{projectId}/problems/{problemId}/issues/{issueId}/attachments/{fileName=**} {
      allow read: if isSignedIn();

      allow write: if isSignedIn() && (
        (request.resource != null && request.resource.metadata.createdBy == request.auth.uid)
        || (request.resource == null && isOwner())
      );
    }

    // ===== ProblemPath: Task attachments =====
    match /projects/{projectId}/problems/{problemId}/issues/{issueId}/tasks/{taskId}/attachments/{fileName=**} {
      allow read: if isSignedIn();

      allow write: if isSignedIn() && (
        (request.resource != null && request.resource.metadata.createdBy == request.auth.uid)
        || (request.resource == null && isOwner())
      );
    }

    // ===== InsurePath: 従業員ドキュメント（書類アップロード）=====
    match /offices/{officeId}/employees/{employeeId}/documents/{documentId}/{fileName} {

      // ユーザーが指定事業所に所属しているかチェック
      function userInOffice() {
        return isSignedIn()
          && exists(/databases/(default)/documents/users/$(request.auth.uid))
          && get(/databases/(default)/documents/users/$(request.auth.uid)).data.officeId == officeId;
      }

      // 管理者または人事担当者かチェック
      function isAdminOrHr() {
        return userInOffice()
          && get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['admin', 'hr'];
      }

      // 自分の従業員レコードに紐づいているかチェック
      function isOwnEmployee() {
        return userInOffice()
          && get(/databases/(default)/documents/users/$(request.auth.uid)).data.employeeId == employeeId;
      }

      // 閲覧・作成・更新: 認証済みユーザーは全員アクセス可能
      // 将来的に従業員ロールはマイページの表示のみにする予定のため、現状は緩いルールで運用
      allow read: if isSignedIn();
      allow create, update: if isSignedIn();
      
      // 将来的に権限を厳格化する場合は、以下のコメントアウトを解除して上記をコメントアウト
      // allow read: if isSignedIn() && (isAdminOrHr() || isOwnEmployee());
      // allow create, update: if isSignedIn()
      //   && request.resource.size < 10 * 1024 * 1024  // 10MB制限
      //   && request.resource.contentType.matches('(application/pdf|image/.*)')
      //   && (isAdminOrHr() || isOwnEmployee());

      // 削除: admin/hr のみ
      allow delete: if isSignedIn() && isAdminOrHr();
    }
  }
}


