# Phase2-8 実装指示書: CSVインポート機能

**作成日**: 2025年11月  
**対象フェーズ**: Phase2-8（CSVインポート機能）

---

## 📋 概要

Phase2-8では、InsurePathシステムにおけるデータの一括インポート機能を実装します。従業員情報をCSV形式で一括登録・更新できるようにし、データ移行や一括登録の効率化を実現します。

**前提フェーズ**: Phase2-7（CSVエクスポート機能）の実装が完了していることが推奨されますが、必須ではありません。

---

## 🎯 目的・ゴール

### Phase2-8（CSVインポート機能）の目的

1. **一括登録**: 新規従業員の一括登録を効率化する
2. **データ移行**: 既存システムからのデータ移行を支援する
3. **バルク更新**: 複数の従業員情報を一度に更新する

---

## 🧭 スコープ

### Phase2-8で実装する範囲

#### 対象機能・ファイル

1. **CSVインポート共通ユーティリティ**
   - `src/app/utils/csv-import.service.ts`（新規作成）
   - CSVパース、バリデーション、エラー検出

2. **従業員情報の一括インポート画面**
   - `src/app/pages/import/import.page.ts`（新規作成）
   - CSVファイル選択、プレビュー、エラー行表示、確認ダイアログ

3. **インポート結果ダイアログ**
   - `src/app/pages/import/import-result-dialog.component.ts`（新規作成）
   - 成功件数、エラー件数、エラー詳細の表示

4. **ルーティング設定**
   - `src/app/app.routes.ts`（拡張）
   - `/import`ルートを追加し、`roleGuard`を適用

#### 対象外とするもの

- 月次保険料・賞与保険料のインポート（将来の拡張として検討）
- 標準報酬履歴のインポート（将来の拡張として検討）
- インポート履歴の管理機能（将来の拡張として検討）

---

## 📝 現状の挙動と課題（Before）

### 現状

- 従業員情報の登録は、1件ずつ手動で入力する必要がある
- 既存システムからのデータ移行時は、1件ずつ手動で入力する必要がある

### 課題

- **一括登録の非効率性**: 新規従業員を複数人登録する際、1件ずつ手動で入力する必要がある
- **データ移行の困難さ**: 既存システムからのデータ移行が非効率

---

## 🔄 仕様（Before / After）

### Before

- 従業員情報の登録は、1件ずつ手動で入力する必要がある

### After（Phase2-8）

- 専用のインポート画面から、CSVファイルを選択して一括登録できる
- CSVファイルの形式チェック、必須項目のバリデーション、エラー行の表示が行われる
- 確認ダイアログで、インポート対象の件数とエラー件数を確認してから実行できる
- インポート結果は、成功件数・エラー件数・エラー詳細を表示するダイアログで確認できる

---

## 🗂️ データモデル・CSVレイアウト仕様

### CSVインポート形式

#### 従業員情報のCSV形式

**CSVファイル形式**: Phase2-7でエクスポートされるCSV形式と同じ形式を受け付ける

**ヘッダ行の仕様**:
- 1行目（ヘッダ行）は、Phase2-7のエクスポートと同じ「日本語カラム名」を前提とする（例: `氏名,生年月日,所属,住所,...`）
- インポート時は、ヘッダ名（日本語）と内部フィールド名（`name`, `birthDate`など）をマッピングしてパースする
- ヘッダ行の順序は、Phase2-7でエクスポートされる順序と同じである必要はないが、ヘッダ名の一致が必要

**必須フィールド**（内部フィールド名）:
- `id`（既存レコード更新時は必須、新規作成時は任意）
- `name`（氏名）
- `birthDate`（生年月日、YYYY-MM-DD形式）
- `hireDate`（入社日、YYYY-MM-DD形式）
- `employmentType`（雇用形態）
- `monthlyWage`（標準報酬月額）
- `isInsured`（社会保険加入フラグ、`true`/`false`）

**任意フィールド**（内部フィールド名）:
- `kana`（フリガナ）
- `department`（所属部署）
- `address`（住所）
- `phone`（電話番号）
- `contactEmail`（メールアドレス）
- `retireDate`（退職日）
- `weeklyWorkingHours`（所定労働時間）
- `weeklyWorkingDays`（所定労働日数）
- `isStudent`（学生フラグ、`true`/`false`）
- その他の`Employee`型のフィールド

**注意**: 上記の「必須フィールド」「任意フィールド」は、`Employee`型のフィールド名を指しており、CSVヘッダ行の文字列そのものではない。CSVヘッダ行には日本語カラム名（例: `氏名`, `生年月日`）が記載され、それを内部フィールド名（`name`, `birthDate`）にマッピングする。

**既存レコードの更新判定**:
- `id`フィールドが存在し、Firestoreに該当するドキュメントが存在する場合 → 更新
- `id`フィールドが存在しない、または該当するドキュメントが存在しない場合 → 新規作成
- 将来的な拡張として、`name` + `birthDate`の組み合わせで既存レコードを検索する機能も検討可能

---

## 🎨 UI/UX仕様

### インポート画面（`import.page.ts`）

**画面構成**:
1. **ファイル選択セクション**
   - CSVファイル選択ボタン（`<input type="file" accept=".csv">`）
   - 選択されたファイル名の表示

2. **プレビューセクション**
   - CSVファイルの内容をテーブル形式でプレビュー表示（最大10行まで）
   - エラー行は赤色でハイライト表示

3. **エラー行表示セクション**
   - バリデーションエラーがある行の行番号とエラー内容をリスト表示

4. **確認ダイアログ**
   - インポート実行前に、対象件数・エラー件数を確認
   - 「インポート実行」ボタンと「キャンセル」ボタン

5. **インポート結果ダイアログ**
   - 成功件数・エラー件数の表示
   - エラー詳細のリスト表示（行番号、エラー内容）

**画面フロー**:
1. ユーザーがCSVファイルを選択
2. ファイルをパースしてプレビュー表示
3. バリデーションを実行してエラー行を検出
4. エラー行があれば、エラー内容を表示
5. 「インポート実行」ボタンをクリック
6. 確認ダイアログを表示
7. 「インポート実行」をクリックして実行
8. インポート結果ダイアログを表示

---

## 🔧 サービス層 / 実装設計

### CSVインポートサービス

#### `src/app/utils/csv-import.service.ts`（新規作成）

**サービスの責務**:
- CSVファイルのパース
- バリデーション（必須項目チェック、データ型チェック、形式チェック）
- エラー行の検出とエラーメッセージの生成

**メソッドシグネチャ（TypeScript疑似コード）**:

```typescript
@Injectable({ providedIn: 'root' })
export class CsvImportService {
  /**
   * CSVファイルをパースして従業員データの配列に変換
   * @param file - CSVファイル（Fileオブジェクト）
   * @returns パース結果（成功データとエラー行の情報）
   * 
   * 注意: パース直後のデータは必須項目が揃っていない可能性があるため、
   * 戻り値の型は`CsvParseResult<Partial<Employee>>`とする。
   * バリデーションで必須項目をチェックしてから、`Employee`型に整形して`importEmployees`に渡す。
   */
  async parseEmployeesCsv(file: File): Promise<CsvParseResult<Partial<Employee>>>;

  /**
   * 従業員データのバリデーション
   * @param employee - バリデーション対象の従業員データ
   * @param rowIndex - 行番号（エラーメッセージ用）
   * @returns バリデーションエラーの配列（エラーがない場合は空配列）
   */
  validateEmployee(employee: Partial<Employee>, rowIndex: number): ValidationError[];

  /**
   * バリデーション済みの従業員データをFirestoreに保存
   * @param officeId - 事業所ID
   * @param employees - 保存対象の従業員データ配列
   * @returns 保存結果（成功件数、エラー件数、エラー詳細）
   */
  async importEmployees(
    officeId: string,
    employees: Employee[]
  ): Promise<ImportResult>;
}

/**
 * CSVパース結果の型
 */
interface CsvParseResult<T> {
  /** パース成功したデータの配列（バリデーション前のため、必須項目が揃っていない可能性がある） */
  data: T[];
  /** エラー行の情報 */
  errors: CsvParseError[];
}

/**
 * CSVパースエラーの型
 */
interface CsvParseError {
  /** 行番号（1始まり） */
  rowIndex: number;
  /** エラーメッセージ */
  message: string;
  /** エラーが発生したカラム名（オプション） */
  column?: string;
}

/**
 * バリデーションエラーの型
 */
interface ValidationError {
  /** 行番号（1始まり） */
  rowIndex: number;
  /** エラーメッセージ */
  message: string;
  /** エラーが発生したフィールド名 */
  field: string;
}

/**
 * インポート結果の型
 */
interface ImportResult {
  /** 成功件数（新規作成 + 更新の合計） */
  successCount: number;
  /** 新規作成件数 */
  createdCount: number;
  /** 更新件数 */
  updatedCount: number;
  /** エラー件数 */
  errorCount: number;
  /** エラー詳細 */
  errors: ImportError[];
}

/**
 * インポートエラーの型
 */
interface ImportError {
  /** 行番号（1始まり） */
  rowIndex: number;
  /** エラーメッセージ */
  message: string;
}
```

**実装のポイント**:
- CSVパースには、`papaparse`などのライブラリを利用することを検討
- パース直後のデータは`Partial<Employee>`型として扱い、バリデーションで必須項目をチェック
- バリデーション通過後、`Employee`型に整形してから`importEmployees`に渡す
- 既存レコードの更新は、`id`フィールドまたは`name` + `birthDate`の組み合わせで判定
- エラーハンドリングは、部分的な成功も許容し、エラー行だけをスキップする
- `ImportResult`では、新規作成件数（`createdCount`）と更新件数（`updatedCount`）を分けて記録する

---

## 🔒 Firestore / セキュリティルールへの影響

**Firestoreルールへの影響**: **なし**

**理由**: CSVインポート機能は、既存の`EmployeesService.save()`メソッドを利用してデータを保存するため、既存のFirestoreルール（`isAdminOrHr`による書き込み制御）をそのまま利用できます。

**画面側の権限制御**:
- インポート画面へのアクセスは、`admin`/`hr`ロールのみに許可する
- `app.routes.ts`に`roleGuard`を適用して、`employee`ロールからのアクセスを拒否

---

## 📁 対象ファイル一覧と、ファイルごとの変更方針

### Phase2-8で作成・変更するファイル

#### 1. `src/app/utils/csv-import.service.ts`（新規作成）

**変更内容**:
- CSVインポート機能の共通サービスを実装
- `parseEmployeesCsv()`、`validateEmployee()`、`importEmployees()`メソッドを実装

#### 2. `src/app/pages/import/import.page.ts`（新規作成）

**変更内容**:
- CSVファイル選択、プレビュー表示、エラー行表示、確認ダイアログ、インポート実行の機能を実装

#### 3. `src/app/pages/import/import-result-dialog.component.ts`（新規作成）

**変更内容**:
- インポート結果（成功件数、エラー件数、エラー詳細）を表示するダイアログコンポーネントを実装

#### 4. `src/app/app.routes.ts`（拡張）

**変更内容**:
- `/import`ルートを追加し、`roleGuard`を適用（`admin`/`hr`のみアクセス可能）

---

## 🛠️ 実装ステップ

#### Step 1: CSVインポートサービスの実装

1. `src/app/utils/csv-import.service.ts`を新規作成
2. `CsvImportService`クラスを実装
3. `parseEmployeesCsv()`メソッドを実装（`papaparse`ライブラリを利用）
4. `validateEmployee()`メソッドを実装（必須項目チェック、データ型チェック）
5. `importEmployees()`メソッドを実装（`EmployeesService.save()`を呼び出して保存）

#### Step 2: インポート画面の実装

1. `src/app/pages/import/import.page.ts`を新規作成
2. CSVファイル選択機能を実装
3. CSVパース・プレビュー表示機能を実装
4. バリデーション・エラー行表示機能を実装
5. 確認ダイアログを実装
6. インポート実行機能を実装

#### Step 3: インポート結果ダイアログの実装

1. `src/app/pages/import/import-result-dialog.component.ts`を新規作成
2. 成功件数・エラー件数の表示
3. エラー詳細のリスト表示

#### Step 4: ルーティング設定

1. `src/app/app.routes.ts`に`/import`ルートを追加
2. `roleGuard`を適用（`admin`/`hr`のみアクセス可能）

#### Step 5: 動作確認・テスト

1. 正しい形式のCSVファイルをインポートし、正常に登録されることを確認
2. エラー行を含むCSVファイルをインポートし、エラー行が適切に表示されることを確認
3. 部分的な成功時も、エラー行だけがスキップされることを確認

---

## ✅ テスト観点・受け入れ条件

#### テストケース1: 正しい形式のCSVファイルのインポート

**前提条件**:
- `admin`または`hr`ロールでログインしている
- 正しい形式のCSVファイル（必須項目がすべて入力されている）を準備

**実行手順**:
1. インポート画面（`/import`）にアクセス
2. CSVファイルを選択
3. プレビューを確認
4. 「インポート実行」ボタンをクリック
5. 確認ダイアログで「インポート実行」をクリック

**期待結果**:
- CSVファイルが正常にパースされる
- バリデーションエラーがない
- すべての従業員データがFirestoreに保存される
- インポート結果ダイアログで、成功件数（`successCount`）、新規作成件数（`createdCount`）、更新件数（`updatedCount`）が正しく表示される

#### テストケース2: エラー行を含むCSVファイルのインポート

**前提条件**:
- `admin`または`hr`ロールでログインしている
- エラー行（必須項目が未入力、データ型が不正など）を含むCSVファイルを準備

**実行手順**:
1. インポート画面（`/import`）にアクセス
2. CSVファイルを選択
3. プレビューを確認
4. エラー行が赤色でハイライト表示されることを確認
5. エラー行表示セクションでエラー内容を確認
6. 「インポート実行」ボタンをクリック
7. 確認ダイアログで、エラー件数が表示されることを確認
8. 「インポート実行」をクリック

**期待結果**:
- エラー行はスキップされ、正常な行のみがFirestoreに保存される
- インポート結果ダイアログで、成功件数（`successCount`）、新規作成件数（`createdCount`）、更新件数（`updatedCount`）、エラー件数（`errorCount`）が正しく表示される
- エラー詳細に、行番号とエラー内容が表示される

#### テストケース3: 既存レコードの更新

**前提条件**:
- `admin`または`hr`ロールでログインしている
- 既存の従業員レコードが存在する
- CSVファイルに、既存レコードの`id`または`name` + `birthDate`の組み合わせが含まれている

**実行手順**:
1. インポート画面（`/import`）にアクセス
2. CSVファイルを選択
3. 「インポート実行」ボタンをクリック
4. 確認ダイアログで「インポート実行」をクリック

**期待結果**:
- 既存レコードが更新される（新規作成されない）
- インポート結果ダイアログで、更新件数（`updatedCount`）が正しく表示される
- 新規作成件数（`createdCount`）は0、更新件数（`updatedCount`）が正の値として表示される

#### テストケース4: 権限制御の確認

**前提条件**:
- `employee`ロールでログインしている

**実行手順**:
1. `/import`に直接アクセスを試みる

**期待結果**:
- アクセスが拒否され、適切なページ（`/me`など）にリダイレクトされる

---

## ⚠️ 注意点・今後の拡張余地

### Phase2-8で注意すべき点

1. **バリデーション**: 既存の`Employee`型の必須項目をチェックし、データ型の整合性を保つ
2. **エラーハンドリング**: 部分的な成功も許容し、エラー行だけをスキップする設計にする
3. **パフォーマンス**: 大量のデータをインポートする場合、進捗表示を実装することを検討する
4. **CSV形式の互換性**: Phase2-7でエクスポートされるCSV形式と互換性を保つ

### 今後の拡張余地

1. **月次保険料・賞与保険料のインポート**: CSV形式で月次保険料・賞与保険料を一括登録できるようにする
2. **標準報酬履歴のインポート**: CSV形式で標準報酬履歴を一括登録できるようにする
3. **インポート履歴の管理**: インポート実行履歴をFirestoreに保存し、過去のインポート結果を確認できるようにする
4. **CSVテンプレートのダウンロード**: インポート用のCSVテンプレートをダウンロードできるようにする（Phase2-7のエクスポート機能を活用）
5. **既存レコードの検索機能**: `id`フィールドがない場合でも、`name` + `birthDate`の組み合わせで既存レコードを検索して更新できるようにする

---

以上で、Phase2-8（CSVインポート機能）の実装指示書は完了です。

