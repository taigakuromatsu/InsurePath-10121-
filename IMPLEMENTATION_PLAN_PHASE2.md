# Phase2 実装計画

**作成日**: 2025年11月  
**最終更新**: Phase2-1完了後

---

## 📊 Phase1の実装完了状況

### 完了したフェーズ
- ✅ **Phase1-2**: 従業員台帳機能の資格情報・就業状態管理
- ✅ **Phase1-3**: 社会保険料自動計算機能
- ✅ **Phase1-4**: 月次保険料一覧・会社負担集計機能（基本実装）
- ✅ **Phase1-5**: 標準報酬月額・等級・保険プランマスタ管理機能
- ✅ **Phase1-6**: 賞与管理・賞与保険料計算機能
- ✅ **Phase1-7**: マイページ機能
- ✅ **Phase1-8**: 従業員とユーザーアカウントの自動紐づけ機能
- ✅ **Phase1-9**: 月次保険料一覧機能の拡張（過去月分閲覧、絞り込み、合計行）
- ✅ **Phase1-10**: 負担構成ダッシュボード機能（基本実装）
- ✅ **Phase1-11**: 保険料シミュレーション機能
- ✅ **Phase1-12**: 負担構成ダッシュボード機能の拡張（グラフ表示）
- ✅ **Phase2-1**: セキュリティ・アクセス制御の強化

### Phase1で実装された主要機能
1. **基本機能**
   - 事業所管理、ユーザー・ロール管理、従業員台帳管理

2. **計算・表示機能**
   - 社会保険料自動計算
   - 月次保険料一覧・集計
   - 賞与保険料計算
   - マイページ（従業員別明細）
   - 保険料シミュレーション
   - ダッシュボード（KPIカード + グラフ表示）

3. **マスタ管理**
   - 標準報酬月額・等級・保険プランマスタ管理

### 実装率
- **完全実装**: 約62%（13/21機能）
- **部分実装含む**: 約76%（16/21機能）

---

## 🎯 Phase2の実装方針

Phase2では、**本番環境に向けた必須機能**と**実務上必要な機能**を優先的に実装します。

### Phase2の目標
1. **セキュリティ強化**: 本番環境で安全に運用できるよう、アクセス制御を強化
2. **データ管理の拡充**: 被扶養者管理、標準報酬履歴管理など、実務上必要な機能を追加
3. **運用効率化**: CSVインポート・エクスポート機能により、データ管理の効率を向上

---

## 📋 Phase2の実装フェーズ

### Phase2-1: セキュリティ・アクセス制御の強化 ✅ 完了

**優先度**: 🔴 最高（本番環境に向けた必須機能）  
**推定工数**: 高（3-4週間）  
**推定期間**: 3-4週間  
**依存関係**: なし  
**実装完了日**: 2025年11月

**目的**: Firestoreセキュリティルールと画面レベルのアクセス制御を強化し、本番環境で安全に運用できるようにする

**実装内容**:
1. **Firestoreセキュリティルールの詳細化** ✅
   - ✅ 事業所IDに基づくデータ分離（`offices/{officeId}`配下のデータは、その事業所のユーザーのみアクセス可能）
   - ✅ InsurePath向けのユーティリティ関数追加（`currentUser`, `getUserRole`, `belongsToOffice`, `isAdminOrHr`, `isInsureAdmin`, `isInsureEmployee`, `isOwnEmployee`）
   - ✅ ロール別のアクセス制御（admin/hr/employee）
   - ✅ 読み取り・書き込み権限の細分化
   - ✅ 従業員情報の更新権限（admin/hrのみ）
   - ✅ 保険料計算・保存権限（admin/hrのみ）
   - ✅ 各コレクション（事業所情報、従業員情報、月次保険料、賞与保険料、マスタ情報）への詳細なアクセス制御
   - ✅ 既存の緩いルールのコメントアウト（テスト完了後に削除予定）

2. **画面レベルのアクセス制御** ✅
   - ✅ `roleGuard`の実装（`src/app/guards/role.guard.ts`）
   - ✅ ロール別のメニュー表示制御（`app.ts`で実装）
   - ✅ 機能へのアクセス制限（`app.routes.ts`に`roleGuard`を適用）
   - ✅ 権限がない場合の適切なリダイレクト（`/me`へ遷移）
   - ✅ 管理者専用機能の保護（`/offices`, `/masters`は`admin`のみ）
   - ✅ 管理者・人事担当者用機能の保護（`/dashboard`, `/employees`, `/premiums`, `/simulator`は`admin`/`hr`のみ）

3. **識別情報のマスキング表示**
   - ⚠️ 個人情報の一部マスキング（電話番号、メールアドレスなど）は未実装（将来の拡張として検討）
   - ✅ 権限に応じた表示制御（employeeロールは自分の情報のみ閲覧可能）はFirestoreルールとガードで実現

**実装されたファイル**:
- ✅ `firestore.rules`（大幅拡張、InsurePath向けルール追加）
- ✅ `src/app/guards/role.guard.ts`（新規作成）
- ✅ `src/app/app.routes.ts`（`roleGuard`追加）
- ✅ `src/app/app.ts`（サイドメニューのロール別表示制御）

**技術要件**:
- ✅ Firestoreセキュリティルールの理解と実装
- ✅ Angular Guardsの活用
- ✅ ロール管理の実装

**注意事項**:
- ✅ 既存データへの影響を最小限に抑える（既存の緩いルールはコメントアウト）
- ⚠️ セキュリティルールのテスト（Firestore Emulator Suiteでのテスト推奨）
- ⚠️ 本番環境への移行前に、ステージング環境で十分な検証を行うことを推奨

---

### Phase2-2: ロール割り当てとユーザー管理の改善

**優先度**: 🔴 最高（Phase2-1のセキュリティ実装と密接に関連）  
**推定工数**: 中（1-2週間）  
**推定期間**: 1-2週間  
**依存関係**: Phase2-1（セキュリティ強化後が望ましい）

**目的**: 
- 「ログインしただけで全員 admin になる」現状を解消し、安全で自然なロール割り当てにする
- 「誰がどの事業所の何ロールか」を管理画面から明示的にコントロールできるようにする
- Firestore ルールでのロール制御（Phase2-1）と、ロールのライフサイクル仕様をきちんと揃える

**現状の課題**:
- 初回ログイン時に `users/{uid}` が自動生成され、その `role` が常に `admin` になっている
- そのため、どのアカウントも admin として扱われてしまい、セキュリティ意図と一致していない
- `officeId` / `role` / `employeeId` の関係が、仕様として十分に整理されていない

**実装内容**:

1. **初回ログイン時のロール初期化**
   - `users/{uid}` が存在しない場合は、以下の値で作成する：
     - `role: 'employee'`
     - `officeId: null`
     - `employeeId: null`
   - この時点では、どの事業所にも属さず、実質的に何もできないユーザーとする
   - 既存ユーザーの `role` は変更しない（マイグレーションは別フェーズで検討）

2. **新規事業所作成時の初代admin設定**
   - `/office-setup` などで新規に `offices/{officeId}` を作成したユーザーは、そのオフィスの「初代 admin」として扱う
   - オフィス作成完了時に、そのユーザーの `users/{uid}` を次のように更新する：
     - `officeId = 作成した officeId`
     - `role = 'admin'`
   - これにより、各オフィスに必ず少なくとも 1 人の admin が存在する状態からスタートする

3. **既存オフィスへのメンバー追加仕様の整理**
   - デフォルトでは、ログイン直後のユーザーは `officeId: null, role: 'employee'` のまま
   - **admin が明示的にユーザーを自分のオフィスに参加させる** ことで、初めてそのオフィスのメンバーになる
   - admin は以下の操作ができる（のちの「ユーザー管理画面」で実装予定）：
     - 任意の `users` ドキュメントに対して `officeId` を自分のオフィス ID に設定する
     - `role` を `'admin' | 'hr' | 'employee'` のいずれかに変更する
   - 最初に office に参加させるときの初期ロールは `employee` を基本とし、必要に応じて admin が `hr` や `admin` に昇格させる

4. **ロール変更の制約**
   - **他ユーザーの `role` / `officeId` を変更できるのは admin のみ**
   - `hr` / `employee` は、自分を含めロール・事業所の変更はできない
   - ある `officeId` に属する admin が 1 人だけの場合、その admin は自分の `role` を `hr` / `employee` に落とせないようにする
     （「最後の admin を消さない」制約。実装は別フェーズで検討してもよい）
   - ロール変更時の UI 文言例：
     - 「この事業所から admin がいなくなってしまうため、ロールを変更できません。」など

5. **`employee` ロールと `employeeId` の関係**
   - `role = 'employee'` に設定する場合は、同じ `officeId` 配下の従業員レコードから 1 件を選び、`employeeId` に設定する運用とする
   - これはまず UI 側のバリデーションで対応し、必要であれば Firestore ルールでの厳密チェックは別フェーズで追加する
   - `admin` / `hr` については `employeeId` は任意（本人も従業員であれば紐づけてもよい）

**Phase2-2で実装する範囲**:
- 初回ログイン時の `users/{uid}` 初期値の変更（`role: 'employee'`, `officeId: null`, `employeeId: null`）
- 新規オフィス作成直後に、そのユーザーを当該オフィスの admin に昇格させる処理の追加
- 既存の Firestore ルール（Phase2-1）の `getUserRole` / `belongsToOffice` / `isAdminOrHr` 等と矛盾しないように、仕様レベルで整合性を保つ

**将来の拡張（別フェーズ）**:
- 本格的な「ユーザー管理画面（ユーザー一覧 + ロール/事業所変更 UI）」の実装
- 既存ユーザーのロールマイグレーション機能
- 「最後の admin を消さない」制約の実装

**関連ファイル**:
- `src/app/services/auth.service.ts`（`ensureUserDocument`メソッドの修正）
- `src/app/pages/office-setup/office-setup.page.ts`（オフィス作成後のロール更新処理追加）
- `src/app/services/current-user.service.ts`（必要に応じて拡張）

**技術要件**:
- ユーザープロファイルの初期化ロジックの変更
- オフィス作成時のロール更新処理
- 既存のFirestoreルールとの整合性確認

**注意事項**:
- Phase2-1のセキュリティルールと整合性を保つ必要がある
- 既存ユーザーへの影響を最小限に抑える（既存ユーザーの`role`は変更しない）
- ロール変更の制約を明確に定義する

---

### Phase2-3: 被扶養者管理機能の実装

**優先度**: 🟡 中（実務上必要な機能）  
**推定工数**: 中（2-3週間）  
**推定期間**: 2-3週間  
**依存関係**: Phase2-1（セキュリティ強化後が望ましい）

**目的**: 従業員の被扶養者情報を管理できる機能を実装する

**実装内容**:
1. **被扶養者情報の型定義**
   - `Dependent`型の定義（氏名、続柄、生年月日、資格取得日・喪失日など）
   - Firestoreコレクション構造の設計（`offices/{officeId}/employees/{employeeId}/dependents`）

2. **被扶養者登録・編集画面**
   - 基本情報の入力（氏名、続柄、生年月日、続柄など）
   - 資格取得日・喪失日の管理
   - 従業員との紐づけ
   - バリデーション（続柄の妥当性、生年月日の妥当性など）

3. **被扶養者一覧表示**
   - 従業員別の被扶養者一覧
   - 資格状況の表示（有効/無効）
   - 資格取得日・喪失日の表示

4. **年次見直し支援機能**（オプション）
   - 基準年月日時点での被扶養者抽出
   - 資格状況の確認機能

**関連ファイル**:
- `src/app/types.ts`（型定義追加）
- `src/app/services/dependents.service.ts`（新規）
- `src/app/pages/dependents/dependents.page.ts`（新規）
- `src/app/pages/dependents/dependent-form-dialog.component.ts`（新規）
- `src/app/pages/employees/employee-detail-dialog.component.ts`（拡張：被扶養者情報の表示）

**技術要件**:
- Firestoreコレクション設計
- 従業員とのリレーション管理
- 資格取得・喪失日の管理ロジック

**注意事項**:
- 被扶養者の資格取得・喪失日の管理は、実務上のルールに従う
- 年次見直し支援機能は、将来的な拡張として検討可能

---

### Phase2-4: 標準報酬決定・改定履歴管理機能の実装

**優先度**: 🟡 中（実務上必要な機能）  
**推定工数**: 中（2-3週間）  
**推定期間**: 2-3週間  
**依存関係**: Phase2-1（セキュリティ強化後が望ましい）

**目的**: 従業員の標準報酬決定・改定履歴を管理できる機能を実装する

**実装内容**:
1. **履歴管理の型定義**
   - `StandardRewardHistory`型の定義（従業員ID、決定年月、標準報酬月額、決定区分など）
   - Firestoreコレクション構造の設計（`offices/{officeId}/employees/{employeeId}/standardRewardHistories`）

2. **履歴登録・閲覧画面**
   - 履歴登録画面（決定年月、標準報酬月額、決定区分の入力）
   - 履歴一覧表示（時系列順）
   - 履歴詳細表示

3. **適用開始年月の管理**
   - 決定年月からの適用開始年月の自動計算
   - 改定時の適用開始年月の管理

4. **決定区分の管理**
   - 決定区分の選択（定時決定、随時改定、賞与支払時の改定など）
   - 決定区分に応じた表示

**関連ファイル**:
- `src/app/types.ts`（型定義追加）
- `src/app/services/standard-reward-history.service.ts`（新規）
- `src/app/pages/standard-reward-histories/standard-reward-histories.page.ts`（新規）
- `src/app/pages/standard-reward-histories/history-form-dialog.component.ts`（新規）
- `src/app/pages/employees/employee-detail-dialog.component.ts`（拡張：履歴情報の表示）

**技術要件**:
- Firestoreコレクション設計
- 従業員とのリレーション管理
- 時系列データの管理

**注意事項**:
- 標準報酬決定・改定のルールは、実務上のルールに従う
- 履歴データは、月次保険料計算時のスナップショットとしても活用可能

---

### Phase2-5: CSVインポート・エクスポート機能の実装

**優先度**: 🟡 中（運用効率化のための機能）  
**推定工数**: 中（2-3週間）  
**推定期間**: 2-3週間  
**依存関係**: Phase2-1（セキュリティ強化後が望ましい）

**目的**: 従業員情報や保険料データの一括インポート・エクスポート機能を実装する

**実装内容**:
1. **CSVエクスポート機能**
   - 月次保険料一覧のエクスポート（年月指定、従業員指定）
   - 従業員台帳のエクスポート（全件またはフィルタ条件指定）
   - 賞与一覧のエクスポート（年度指定、従業員指定）
   - CSV形式の定義（列の順序、エンコーディングなど）

2. **CSVインポート機能**
   - 従業員情報の一括インポート
   - CSV形式のチェック（必須項目、データ型、バリデーション）
   - エラー行の確認・修正画面
   - インポート進捗の表示
   - インポート結果のサマリー表示

3. **エラーハンドリング**
   - 形式エラーの検出と表示
   - データ整合性エラーの検出と表示
   - 部分的なインポート成功時の処理

**関連ファイル**:
- `src/app/utils/csv-export.service.ts`（新規）
- `src/app/utils/csv-import.service.ts`（新規）
- `src/app/pages/import/import.page.ts`（実装）
- `src/app/pages/import/import-result-dialog.component.ts`（新規）
- 各一覧ページ（エクスポートボタンの追加）

**技術要件**:
- CSVパーサーライブラリの活用（例: `papaparse`）
- エラーハンドリング
- 進捗表示（大量データのインポート時）

**注意事項**:
- CSV形式の仕様を明確に定義する
- インポート時のデータ整合性チェックを十分に行う
- 大量データのインポート時のパフォーマンスを考慮する

---

## 📅 Phase2の推奨実装順序

### 第1段階（必須機能）
1. **Phase2-1: セキュリティ・アクセス制御の強化** ✅ 完了
   - 本番環境に向けた必須機能
   - 他の機能の基盤となるため、最優先で実装
   - 推定期間: 3-4週間
   - **実装完了**: Firestoreセキュリティルールの詳細化、Angular側の`roleGuard`実装、ルーティング設定への適用、サイドメニューのロール別表示制御が完了

### 第2段階（セキュリティ関連の補完）
2. **Phase2-2: ロール割り当てとユーザー管理の改善**
   - Phase2-1のセキュリティ実装と密接に関連
   - Phase2-1完了後、できるだけ早く実装することを推奨
   - ロールのライフサイクル仕様を整備し、セキュリティルールと整合性を保つ
   - 推定期間: 1-2週間

### 第3段階（実務上必要な機能）
3. **Phase2-3: 被扶養者管理機能の実装**
   - 実務上必要な機能
   - Phase2-1完了後に実装
   - 推定期間: 2-3週間

4. **Phase2-4: 標準報酬決定・改定履歴管理機能の実装**
   - 実務上必要な機能
   - Phase2-1完了後に実装
   - Phase2-3と並行実装可能
   - 推定期間: 2-3週間

### 第4段階（運用効率化）
5. **Phase2-5: CSVインポート・エクスポート機能の実装**
   - 運用効率化のための機能
   - Phase2-1完了後に実装
   - 他の機能と並行実装可能
   - 推定期間: 2-3週間

---

## 🔍 各フェーズの詳細検討事項

### Phase2-1（セキュリティ）
- **ルール設計**: Firestoreセキュリティルールの複雑さを考慮
- **テスト**: セキュリティルールのテスト方法（Firebase Emulator Suiteの活用）
- **移行**: 既存データへの影響を最小限に抑える
- **パフォーマンス**: セキュリティルールによるクエリ性能への影響

### Phase2-2（ロール割り当て）
- **初期化ロジック**: 初回ログイン時のロール初期化の実装
- **オフィス作成**: 新規オフィス作成時の初代admin設定処理
- **ロール変更制約**: adminのみがロール変更可能という制約の実装
- **整合性**: Phase2-1のFirestoreルールとの整合性確認

### Phase2-3（被扶養者管理）
- **データモデル**: 被扶養者情報の構造設計（従業員とのリレーション）
- **資格管理**: 資格取得・喪失日の管理ロジック
- **年次見直し**: 年次見直し支援機能の必要性と実装範囲

### Phase2-4（標準報酬履歴）
- **データモデル**: 履歴情報の構造設計（従業員とのリレーション）
- **決定区分**: 決定区分の種類と管理方法
- **適用開始**: 適用開始年月の自動計算ロジック

### Phase2-5（CSV機能）
- **形式定義**: CSV形式の仕様定義（列の順序、エンコーディング、必須項目など）
- **エラーハンドリング**: インポート時のエラー処理とユーザーフィードバック
- **バリデーション**: データ整合性チェックの範囲と方法
- **パフォーマンス**: 大量データのインポート時の処理速度

---

## 📌 注意事項

- **Phase2-1（セキュリティ）は最優先**: 本番環境に向けた必須機能のため、他の機能より優先して実装する
- **Phase2-2（ロール割り当て）はPhase2-1直後に実装推奨**: Phase2-1のセキュリティ実装と密接に関連するため、できるだけ早く実装することを推奨
- **段階的な実装**: Phase2-1完了後、Phase2-3とPhase2-4は並行実装可能
- **テストの重要性**: 特にPhase2-1では、セキュリティルールのテストを十分に行う
- **既存機能への影響**: Phase2-1の実装により、既存機能への影響がある可能性があるため、十分な検証を行う

---

## 🚀 Phase2以降の展望

Phase2完了後、以下の機能をPhase3として検討可能：

1. **社会保険手続き履歴・期限管理機能（(19)）**
   - 手続き履歴の型定義とCRUD機能
   - 提出期限の自動計算
   - 期限切れアラート

2. **納付状況管理機能（(21)）**
   - 納付状況の型定義とCRUD機能
   - 納付予定額・実納付額の記録
   - 納付ステータス管理

3. **社会保険用語・ルールヘルプ機能（(17)）**
   - ヘルプコンテンツの作成
   - ヘルプアイコン・モーダルの実装

4. **従業員情報の変更申請・承認機能（(18)）**
   - 申請登録画面
   - 承認・却下機能
   - 申請一覧表示

---

以上でPhase2の実装計画は完了です。各フェーズの詳細な実装指示書は、実装開始前に作成することを推奨します。

