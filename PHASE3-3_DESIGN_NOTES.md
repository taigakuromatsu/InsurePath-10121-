# Phase3-3: プロフィール変更申請機能の方針メモ（暫定）

**作成日**: 2025年11月30日  
**目的**: Phase3-3で実装した「従業員情報の変更申請・承認（簡易ワークフロー）機能」について、現在の運用方針と将来の設計方針を記録する

---

## 1. 現在の運用方針（Phase3-3 時点）

### 1.1 申請の入口

- プロフィール変更申請は **Myページ（`/me`）からのみ行う**。
- メニュー上も「マイページ＝自分の情報を見る／変更申請する場所」という位置づけ。

### 1.2 誰が申請できるか

- **`employeeId`を持つユーザーであれば、ロールに関係なく申請可能**（employee / admin / hr 共通）。
- マイページが表示できていれば、その人自身の情報に対して申請できる。

### 1.3 誰が承認できるか

- 同じ`office`の**admin / hr ロールユーザー**が承認・却下できる。
- 現時点では、**Adminが自分で出した申請を自分で承認できてしまう状態を「暫定的に許容」する**。
  - あくまで Phase3-3 の範囲では「仕様上 NG ではない」という扱いとする。

### 1.4 UI の分かりやすさ

- いまは他ページからの導線は増やさず、
  - 「マイページを開く → そこで申請ボタンが見える」という前提で運用。
- 将来のロール別画面設計を前提に、今は最低限の導線のみにとどめる。

---

## 2. 将来の設計方針（ロール別画面＋権限制御の方向性）

今後 Phase4 以降で、以下のように詰めていく方針とする。

### 2.1 ロール別に見える画面をはっきり分ける

#### employee ロール

- 基本的には **`/me`（マイページ）を中心としたシンプルな画面構成**。
- 変更申請はマイページからのみ行う想定。
- これにより、「どこから申請するのか？」が直感的に分かる。

#### admin / hr ロール

- `/dashboard`, `/employees`, `/requests` など、事務担当者向け画面を利用。
- 他人の社員情報の変更は、原則 `/employees` から直接編集するのを基本とする。

### 2.2 自己申請・自己承認の扱い

- **将来の改善案として**、
  - 「`requestedByUserId` と `decidedByUserId` が同じ場合は承認不可」という制約を検討する。
- **実装場所の候補**：
  - Firestore ルールでチェックする
  - もしくは Functions / サービス層でバリデーションする
- ただしこれは **Phase3-3 以降の改善テーマ**とし、今すぐは実装しない。

### 2.3 導線のわかりやすさの強化

#### employee ロールに対して：

- サイドメニューやトップから「マイページ」への導線を強める。
- 「プロフィール変更を申請したい場合はマイページへ」というメッセージやガイドを追加する。

#### admin / hr に対して：

- 「基本は `/employees` から直接編集、それ以外は申請ワークフロー」というルールを
  ヘルプやマニュアルに明記する。

---

## 3. メモとしての扱い

- 上記は「Phase3-3 時点の暫定仕様＋今後の方針」として記録するだけで、
  - 今すぐ Firestore ルールや UI を追加で変更しない。
- ロール別画面構成や権限を本格的に詰めるタイミングで、
  - このメモをベースに「自己承認禁止」や「employee 専用マイページ運用」を正式仕様として組み込む。

---

## 4. 技術的な実装詳細（参考）

### 4.1 現在の実装

- **申請登録**: `ChangeRequestFormDialogComponent`（マイページから開く）
- **申請一覧**: `RequestsPage`（admin/hr専用、`/requests`）
- **申請履歴**: マイページ内のセクション（employee用、`listForUser()`を使用）
- **承認・却下**: `RequestsPage`から実行

### 4.2 Firestoreセキュリティルール

- **create**: 従業員本人のみ作成可能（`employeeId == currentUser().data.employeeId`）
- **read**: admin/hrは全件、employeeは自分の申請のみ
- **update**: admin/hrのみ更新可能（承認・却下）
- **delete**: 許可しない（履歴として保持）

### 4.3 注意事項

- `listForUser()`を使用してクエリで`requestedByUserId`を絞り込む必要がある（Firestoreルールと整合性を保つため）
- submit 2重実行バグは修正済み（`type="submit"`を使用）
- 却下理由の空文字はFirestoreルールで禁止（`rejectReason.size() > 0`）

---

以上

