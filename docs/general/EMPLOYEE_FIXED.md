# 標準報酬管理の改良実装指示書

## 概要

標準報酬の真実を`StandardRewardHistory`に統一し、従業員フォームでは標準報酬を編集不可（表示のみ）にする。標準報酬履歴フォームに報酬月額の参照表示と自動追加機能を追加する。

## 方針

### 0. 大方針（真実の置き場所）

- 標準報酬の"真実"は標準報酬履歴（`StandardRewardHistory`）に置く
- 健保・厚年は別レコード／別適用年月を許容（現状設計を活かす）
- 従業員フォーム（`Employee`）は標準報酬を編集しない
- ただし「現在有効な標準報酬（健保・厚年）」は表示のみ（参照表示）

### 1. 報酬月額（insurableMonthlyWage）の扱い

- 報酬月額は従業員マスタ（`Employee`）の一部として保持する（入力・編集は従業員フォームで行う）
- 報酬月額は「標準報酬を決めるための材料」であり、標準報酬そのものではない
- 標準報酬履歴フォームでは：
  - 報酬月額は表示のみ（従業員マスタに報酬月額が入っていれば表示）
  - 従業員マスタに報酬月額が入っていれば自動追加ボタンで参照して使う（閲覧のみ・変更不可）
  - 履歴フォーム上で報酬月額を直接編集はしない（編集は従業員フォームへ誘導）

### 2. 従業員フォームの表示仕様（標準報酬は編集不可）

従業員フォームには以下を表示：

- 現在有効な標準報酬（健保）：等級・標準報酬月額・適用開始年月（表示のみ）
- 現在有効な標準報酬（厚年）：等級・標準報酬月額・適用開始年月（表示のみ）

これらは必ず履歴から算出した値を表示する（`Employee`直持ち値を真実にしない）

「標準報酬履歴を編集」ボタンを配置して、編集はそちらへ

### 3. "自動追加"ボタンの扱い（現行の良いUXを維持）

現状実装（＝自動入力＋確認ダイアログ＋そのまま履歴追加）を、方針として正式採用する。

標準報酬履歴フォームでも同じ「自動追加」導線を持つ（ただし健康と厚生年金で分けて使えると今の登録フォームと一致するのでいいかも）

#### 3-1. ボタンの意味

「（報酬月額などから推定した）標準報酬候補を作って、その内容で履歴を追加する」

ただの自動入力ではなく、**自動追加（ワンクッション確認付き）**が正

#### 3-2. 履歴フォームでも同じUXに統一

標準報酬履歴フォームでも同じ「自動追加」導線を持つ

確認ダイアログに出す内容（最低限）：

- 健保：適用開始年月 / 等級 / 標準報酬月額
- 厚年：適用開始年月 / 等級 / 標準報酬月額

参照元（報酬月額◯円を基に算出、など）を一言添えると親切

### 4. CSV（従業員CSV）の方針：参照列として出すが、インポートは無視

#### 4-1. エクスポート

従業員CSVには、ユーザーの納得感のために以下を参照列として出してよい：

- 現在有効な健保 標準報酬月額 / 等級 / 適用開始年月
- 現在有効な厚年 標準報酬月額 / 等級 / 適用開始年月

ただしこれは**履歴から算出した"現在値のスナップショット"**で、編集対象ではない

#### 4-2. インポート

上記参照列はインポートでは完全に無視（読み捨て）

代わりに、CSVの先頭コメント or インポート画面の注意書きに明記：

「標準報酬は"標準報酬履歴"で管理します。CSVの標準報酬列は参照用で、インポートでは反映されません。」

### 5. 画面/データの整合ルール

保険料計算など、標準報酬が必要な箇所は：

- 履歴の「対象年月に有効なレコード」から取得する（健保/厚年それぞれ）
- 履歴が無い場合は：
  - 「未登録」表示
  - 計算はできないを明示

## 実装タスク

### タスク1: 従業員フォームの標準報酬セクションを表示のみにする

**ファイル**: `src/app/pages/employees/employee-form-dialog.component.ts`

**変更内容**:

1. **標準報酬の入力UIを削除し、テキスト表示に置き換える**
   - `healthStandardMonthly`フィールド: `mat-select`を削除し、テキスト表示に置き換え
   - `pensionStandardMonthly`フィールド: `mat-select`を削除し、テキスト表示に置き換え
   - `healthGrade`フィールド: `input`を削除し、テキスト表示に置き換え（既に`readonly`だが、完全にテキスト表示へ）
   - `pensionGrade`フィールド: `input`を削除し、テキスト表示に置き換え（既に`readonly`だが、完全にテキスト表示へ）
   - 表示ラベル: 「健康保険: 等級 X / 標準報酬月額 Y円（適用開始年月: Z）」
   - 表示ラベル: 「厚生年金: 等級 X / 標準報酬月額 Y円（適用開始年月: Z）」
   - 説明文（`mat-hint`）を追加: 「標準報酬は履歴で管理します。編集は標準報酬履歴フォームで行ってください。」

2. **適用開始年月フィールドを削除し、健保・厚年で別々に表示**
   - `decisionYearMonth`フィールドをフォームから削除（誤保存を防ぐため）
   - 健保の適用開始年月: 履歴から取得してテキスト表示
   - 厚年の適用開始年月: 履歴から取得してテキスト表示
   - これらは標準報酬の表示と一緒に表示する

3. **現在有効な標準報酬を履歴から取得して表示する**
   - `bindEffectiveStandardReward()`メソッドを使用して、履歴から現在値を取得
   - 健保と厚年で別々に取得（適用開始年月も別々）
   - 既存の実装を確認し、正しく動作しているか確認

4. **「標準報酬履歴を開く」ボタンを追加**
   - 標準報酬セクションに「標準報酬履歴を開く」ボタンを追加
   - クリック時に`StandardRewardHistoryDialogComponent`を開く
   - ここからのみ履歴の追加・編集が可能

5. **編集・追加ボタンを削除**
   - 「履歴に追加」ボタンを削除（混乱を避けるため）
   - 「標準報酬履歴自動追加」ボタンを削除（履歴フォームに集約）
   - 報酬月額フィールドは残す（従業員フォームで編集可能）

6. **フォームコントロールの整理**
   - `healthStandardMonthly`、`pensionStandardMonthly`、`healthGrade`、`pensionGrade`、`decisionYearMonth`をフォームから削除
   - これらは表示用のプロパティとして管理（フォームコントロールではない）

7. **削除したコントロールの参照箇所を全探索で除去（必須）**
   - **FormBuilderの定義**: `this.fb.group({ ... })`から削除したコントロールの定義を除去
   - **patchValue() / setValue()**: 削除したコントロールへの設定を除去
   - **form.get('xxx')**: 削除したコントロールへの参照を除去
   - **form.value.xxx**: 保存payload生成時に削除したコントロールの値を参照している箇所を除去
   - **HTMLのformControlName**: 削除したコントロールの`formControlName`が残っていないか確認
   - **検索方法**: `healthStandardMonthly`、`pensionStandardMonthly`、`healthGrade`、`pensionGrade`、`decisionYearMonth`でファイル全体を検索し、参照箇所をすべて除去

**注意点**:
- `mat-select`は`readonly`が効かないため、テキスト表示に置き換える
- `disabled`だとツールチップが出ないことがあるため、説明文（`mat-hint`）で明示する
- 標準報酬の値は`bindEffectiveStandardReward()`で設定される値のみを表示
- フォーム保存時には標準報酬フィールドを保存しない（既に実装済みの可能性）
- 健保・厚年で適用開始年月が異なる可能性があるため、別々に表示する

### タスク2: 標準報酬履歴フォームに報酬月額の表示を追加

**ファイル**: `src/app/pages/employees/standard-reward-history-form-dialog.component.ts`

**変更内容**:

1. **報酬月額の表示フィールドを追加**
   - 従業員マスタから`payrollSettings?.insurableMonthlyWage`を取得
   - 表示のみのフィールドとして追加（`readonly`または`disabled`）
   - ラベル: 「報酬月額（参照）」
   - ヒント: 「報酬月額は従業員フォームで編集してください。」

2. **データ取得処理を追加**
   - `StandardRewardHistoryFormDialogData`に`employee`を追加（原則`employee`を渡す）
   - 開く元（従業員フォーム）で`employee`を渡す（既に持っているはず）
   - `employee`が渡せないケースがある場合はフォールバックで`employeeId`から取得
   - コンポーネントで従業員データを取得して報酬月額を表示

3. **報酬月額が未設定の場合の表示**
   - 報酬月額が未設定の場合は「未設定」と表示
   - またはフィールドを非表示にする

**注意点**:
- 報酬月額は編集不可（表示のみ）
- 従業員フォームへの誘導メッセージを表示
- **原則`employee`を渡し、無ければ`employeeId`で取得（二重取得を避ける）**

### タスク3: 標準報酬履歴フォームに自動追加ボタンを追加

**ファイル**: `src/app/pages/employees/standard-reward-history-form-dialog.component.ts`

**変更内容**:

1. **自動追加ボタンを追加**
   - 報酬月額が設定されている場合のみ表示
   - 健康保険用と厚生年金用の2つのボタンを追加（保険種別に応じて表示）
   - ボタンラベル: 「報酬月額から自動追加（健保）」「報酬月額から自動追加（厚年）」
   - ツールチップ: 「報酬月額から保険マスタデータの等級表をもとに標準報酬履歴を自動追加します。」

2. **自動追加処理を実装**
   - `onAutoAddHistoryClick(insuranceKind: 'health' | 'pension')`メソッドを追加
   - 従業員フォームの`onAutoInputButtonClick()`と同じロジックを使用
   - 報酬月額と適用開始年月から標準報酬を計算
   - 確認ダイアログを表示（`StandardRewardAutoInputConfirmDialogComponent`を使用）
   - 確認後、履歴を追加

3. **確認ダイアログの内容**
   - 適用開始年月 / 等級 / 標準報酬月額を表示
   - 参照元（報酬月額◯円を基に算出）を一言添える
   - 「この内容で履歴を追加」ボタンと「キャンセル」ボタン

4. **同月キー重複のチェック（必須）**
   - 自動追加前に、`(employeeId, insuranceKind, appliedFromYearMonth)`の組み合わせで既存履歴をチェック
   - **実装方法（docId設計に合わせて選択）**:
     - **docIdが固定キーの場合**（例: `insuranceKind + appliedFromYearMonth`）:
       - `getDoc(docRef)`の`exists()`で一発チェック
     - **docIdが自動IDの場合**:
       - `where('insuranceKind', '==', 'health')` && `where('appliedFromYearMonth', '==', '2025-12')`のクエリで確認
   - 既に存在する場合:
     - **デフォルト（提出版）**: エラーで追加しない（SnackBarで通知）
     - メッセージ例: 「この保険種別・適用開始年月の履歴が既に存在します。既存の履歴を編集してください。」
   - 余裕があれば: 上書き確認ダイアログを出す（ただし提出優先なら不要）

5. **自動追加後の処理**
   - 履歴追加後、履歴一覧を更新（親画面をリロード）
   - 従業員フォームの標準報酬表示も更新される（`bindEffectiveStandardReward()`が呼ばれる）

**注意点**:
- 報酬月額が未設定の場合は自動追加ボタンを非表示
- 適用開始年月が未設定の場合は自動追加ボタンを無効化
- エラー時は適切なメッセージを表示
- **同月キー重複チェックは必須**（データ整合性のため）

### タスク4: CSVインポートで標準報酬列を無視する処理を追加

**ファイル**: `src/app/utils/csv-import.service.ts`

**変更内容**:

1. **標準報酬列のsetterを無視するように変更**
   - 以下の列のsetterを空実装にするか、列定義から除外する:
     - `健康保険等級`
     - `健康保険標準報酬月額`
     - `厚生年金等級`
     - `厚生年金標準報酬月額`
     - **`健康保険適用開始年月`**（Task6で追加される参照列）
     - **`厚生年金適用開始年月`**（Task6で追加される参照列）
   - または、setter内で何もしない（値を設定しない）

2. **列定義の確認**
   - `csv-column-definitions.ts`で標準報酬関連の列定義を確認
   - setterが値を設定しないように変更
   - Task6で追加される適用開始年月の列も無視対象に含める

**注意点**:
- エクスポートでは標準報酬列を出力するが、インポートでは無視する
- エラーメッセージは出さない（静かに無視）
- **Task6で追加される参照列（適用開始年月）も必ず無視対象に含める**

### タスク5: CSVテンプレート/インポート画面に注意書きを追加

**ファイル**: 
- `src/app/utils/csv-export.service.ts`（テンプレートのコメント）
- CSVインポート画面のコンポーネント（注意書き）

**変更内容**:

1. **CSVテンプレートのコメントに注意書きを追加**
   - `exportEmployeesTemplate()`メソッドのコメント行に追加
   - 「標準報酬は"標準報酬履歴"で管理します。CSVの標準報酬関連列（健康保険等級、健康保険標準報酬月額、健康保険適用開始年月、厚生年金等級、厚生年金標準報酬月額、厚生年金適用開始年月）は参照用で、インポートでは反映されません。」

2. **CSVインポート画面に注意書きを追加**
   - インポート画面のコンポーネントに注意書きを表示
   - 「標準報酬は"標準報酬履歴"で管理します。CSVの標準報酬関連列（健康保険等級、健康保険標準報酬月額、健康保険適用開始年月、厚生年金等級、厚生年金標準報酬月額、厚生年金適用開始年月）は参照用で、インポートでは反映されません。」

**注意点**:
- ユーザーが混乱しないように明確に記載
- エクスポートとインポートの両方に注意書きを追加

### タスク6: CSVエクスポートで標準報酬を履歴から取得するように変更

**ファイル**: `src/app/utils/csv-export.service.ts`

**変更内容**:

1. **標準報酬列のgetterを変更**
   - `健康保険等級`、`健康保険標準報酬月額`、`厚生年金等級`、`厚生年金標準報酬月額`のgetterを変更
   - `Employee`の直持ち値ではなく、履歴から現在有効な値を取得
   - `StandardRewardHistoryService`を使用して履歴を取得
   - **「現在有効」の定義を明記**:
     - `asOfYearMonth`はローカル時刻(JST)で`YYYY-MM`（例: `2025-12`）に整形すること
     - 取得ルール: `appliedFromYearMonth <= asOfYearMonth`の中で最大のものを採用
     - 注意: 「最新1件」だけ取ると事故る可能性があるため、上記ルールを厳守

2. **適用開始年月の列を追加**
   - 現在有効な標準報酬の適用開始年月を表示する列を追加
   - ヘッダー: 「健康保険適用開始年月」「厚生年金適用開始年月」
   - **これらの列もTask4で無視対象に含めること**

3. **パフォーマンス対策（必須）**
   - **N+1読み取り問題への対策**:
     - 従業員100人 → 履歴取得100回 のような状況を避ける
     - **推奨実装**:
       - **無制限並列は避け、20〜30件ずつのバッチ並列（chunkしてPromise.all）**
       - 簡易キャッシュを実装（同じオフィス内の従業員は同じマスターデータを参照）
       - 可能なら「当月有効の履歴」を一括取得できる形に寄せる（データ構造次第）
   - **小規模前提で許容する場合**:
     - バッチ並列取得とキャッシュで体感速度を落とさない
     - 100人程度なら許容範囲内（バッチ並列取得で数秒程度）

**注意点**:
- エクスポート時に履歴を取得するため、パフォーマンスに注意
- 履歴が無い場合は空欄を出力
- **適用開始年月の列もTask4で無視対象に含めること**
- **N+1読み取り問題を避けるため、バッチ並列取得とキャッシュを実装すること**
- **「現在有効」の定義（asOfYearMonth）と取得ルールを厳守すること**
- **asOfYearMonthはローカル時刻(JST)でYYYY-MM形式に整形すること（JSTずれ・ゼロ埋め漏れを防ぐ）**

## 実装順序

1. **タスク1**: 従業員フォームの標準報酬セクションを表示のみにする（最優先）
2. **タスク2**: 標準報酬履歴フォームに報酬月額の表示を追加
3. **タスク3**: 標準報酬履歴フォームに自動追加ボタンを追加
4. **タスク4**: CSVインポートで標準報酬列を無視する処理を追加
5. **タスク5**: CSVテンプレート/インポート画面に注意書きを追加
6. **タスク6**: CSVエクスポートで標準報酬を履歴から取得するように変更

## テスト項目

### 従業員フォーム

- [ ] 標準報酬の入力UI（mat-select等）が削除され、テキスト表示に置き換えられている
- [ ] 健保・厚年で適用開始年月が別々に表示されている
- [ ] 現在有効な標準報酬が履歴から正しく表示される（健保・厚年それぞれ）
- [ ] 「標準報酬履歴を開く」ボタンが動作する
- [ ] 「履歴に追加」ボタンが削除されている
- [ ] 「標準報酬履歴自動追加」ボタンが削除されている
- [ ] 標準報酬は編集・追加できない（ボタンが存在しない）
- [ ] 「履歴を開く」から追加できる

### 標準報酬履歴フォーム

- [ ] 報酬月額が表示される（編集不可）
- [ ] 報酬月額が未設定の場合は適切に表示される
- [ ] 自動追加ボタンが表示される（報酬月額が設定されている場合）
- [ ] 自動追加ボタンが動作する（健保・厚年それぞれ）
- [ ] 確認ダイアログが正しく表示される
- [ ] 同月キー重複時にエラーメッセージが表示される
- [ ] 自動追加がここで完結する（確認→追加→一覧反映）
- [ ] 手入力で履歴追加が可能（既存機能）

### CSVインポート/エクスポート

- [ ] CSVエクスポートで標準報酬列が出力される（履歴から取得）
- [ ] CSVエクスポートで適用開始年月列が出力される（健保・厚年それぞれ）
- [ ] CSVインポートで標準報酬列が無視される（等級・標準報酬月額）
- [ ] CSVインポートで適用開始年月列が無視される（健保・厚年それぞれ）
- [ ] CSVテンプレートに注意書きが記載されている
- [ ] インポート画面に注意書きが表示される
- [ ] エクスポート時のパフォーマンスが許容範囲内（並列取得・キャッシュ）

## 注意事項

- 既存の`bindEffectiveStandardReward()`メソッドの動作を確認してから実装を開始する
- 標準報酬履歴フォームの自動追加処理は、従業員フォームの実装を参考にする
- CSVエクスポート時のパフォーマンスに注意（履歴取得のオーバーヘッド、N+1問題を避ける）
- ユーザーへの説明を明確にする（なぜ標準報酬が編集不可なのか、どこで編集するのか）
- `mat-select`は`readonly`が効かないため、テキスト表示に置き換える
- 健保・厚年で適用開始年月が異なる可能性があるため、別々に表示する
- **削除したコントロールを参照している箇所を必ず全探索で除去すること（実行時エラーの原因になる）**
- 同月キー重複チェックは必須（データ整合性のため）
- Task6で追加される適用開始年月の列もTask4で無視対象に含めること

