# 次期実装提案（Phase1-9以降）

**作成日**: 2025年11月  
**現状**: Phase1-8完了（マイページ・自動紐づけ機能実装済み）

---

## 📊 実装進捗サマリー

- **完全実装**: 8機能（38%）
- **部分実装**: 4機能（19%）
- **未実装**: 9機能（43%）
- **総合実装率**: 約57%（部分実装含む）

---

## 🎯 次に実装すべき機能の提案

### 優先度: 高（Phase1-9, Phase1-10）

#### Phase1-9: 月次保険料一覧機能の拡張

**目的**: 現在の月次保険料一覧画面を拡張し、過去月分の閲覧・管理を可能にする

**現状の問題点**:
- 現在は当月のみの計算・表示が可能
- 過去月分の保険料を確認できない
- ソート・フィルタリング機能がない

**実装内容**:
1. **年月選択UIの追加**
   - 年月選択ドロップダウン（例: 2025-11, 2025-10...）
   - デフォルトは当月
   - 過去12ヶ月分を選択可能

2. **過去月分の一覧表示**
   - 選択した年月の月次保険料一覧を表示
   - 既に計算済みの場合は表示のみ
   - 未計算の場合は「計算」ボタンを表示

3. **ソート・フィルタリング機能**
   - 従業員名での検索
   - 金額でのソート（本人負担額、会社負担額）
   - 部署でのフィルタリング（将来の拡張）

4. **CSVエクスポート機能**
   - 表示中の月次保険料をCSV形式でエクスポート
   - 列: 従業員名、年月、健康保険（本人/会社）、介護保険（本人/会社）、厚生年金（本人/会社）、合計（本人/会社）

**技術的な実装**:
- `MonthlyPremiumsService.listByOfficeAndYearMonth`は既に実装済み
- 年月選択UIは`MatSelect`を使用
- CSVエクスポートは`papaparse`ライブラリを使用（または手動実装）

**関連ファイル**:
- `src/app/pages/premiums/monthly/monthly-premiums.page.ts`（編集）
- `src/app/services/monthly-premiums.service.ts`（確認・必要に応じて拡張）

---

#### Phase1-10: 負担構成ダッシュボード機能の実装

**目的**: 事業所全体の社会保険料負担を可視化し、経営判断に役立つ情報を提供する

**現状の問題点**:
- ダッシュボードページはプレースホルダーのみ
- 集計データが表示されない
- グラフ表示がない

**実装内容**:
1. **統計カードの実装**
   - 従業員数（社会保険加入者数）
   - 今月の会社負担額合計
   - 今月の本人負担額合計
   - 今月の賞与保険料合計（該当月の場合）

2. **月次推移グラフ**
   - 過去12ヶ月の会社負担額推移
   - 健康保険・介護保険・厚生年金の内訳
   - Chart.jsまたはng2-chartsを使用

3. **年度別集計**
   - 年度（4月1日基準）ごとの集計
   - 月次保険料と賞与保険料の合計
   - 本人負担・会社負担の内訳

4. **従業員別ランキング**
   - 会社負担額が多い従業員トップ10
   - 本人負担額が多い従業員トップ10

**技術的な実装**:
- `MonthlyPremiumsService`と`BonusPremiumsService`からデータを取得
- 集計ロジックを実装（RxJSの`combineLatest`、`map`、`reduce`を使用）
- Chart.jsまたはng2-chartsでグラフ表示
- レスポンシブ対応（モバイルでも見やすい）

**関連ファイル**:
- `src/app/pages/dashboard/dashboard.page.ts`（実装）
- `src/app/services/monthly-premiums.service.ts`（集計メソッド追加）
- `src/app/services/bonus-premiums.service.ts`（集計メソッド追加）
- `package.json`（Chart.jsまたはng2-chartsの追加）

---

### 優先度: 中（Phase1-11, Phase1-12）

#### Phase1-11: セキュリティ・アクセス制御の強化

**目的**: Firestoreセキュリティルールとロール別アクセス制御を実装し、データセキュリティを強化する

**実装内容**:
1. **Firestoreセキュリティルールの詳細化**
   - 事業所間のデータ分離（`officeId`によるアクセス制御）
   - ロール別の読み書き権限（admin/hr/employee）
   - 従業員データのアクセス制御（employeeロールは自分のデータのみ）

2. **画面レベルでのロール別アクセス制御**
   - 管理者専用ページ（マスタ管理、従業員管理）
   - HR専用ページ（保険料計算、従業員管理）
   - 従業員専用ページ（マイページのみ）

3. **識別情報のマスキング表示**
   - 従業員一覧での電話番号・メールアドレスの一部マスキング
   - ロールに応じた表示制御

**関連ファイル**:
- `firestore.rules`（編集）
- `src/app/guards/role.guard.ts`（新規作成）
- 各ページコンポーネント（ロールチェック追加）

---

#### Phase1-12: 保険料シミュレーション機能の実装

**目的**: 報酬月額や等級を入力して、保険料を試算できる機能を提供する

**実装内容**:
1. **入力フォーム**
   - 報酬月額の入力
   - 健康保険等級の選択（または自動判定）
   - 厚生年金等級の選択（または自動判定）
   - 対象年月の選択

2. **計算ロジック**
   - `premium-calculator.ts`の`calculateMonthlyPremiumForEmployee`を再利用
   - 一時的な`Employee`オブジェクトを作成して計算

3. **結果表示**
   - 健康保険・介護保険・厚生年金の内訳
   - 本人負担額・会社負担額
   - 標準報酬月額の表示

**関連ファイル**:
- `src/app/pages/simulator/simulator.page.ts`（実装）
- `src/app/utils/premium-calculator.ts`（再利用）

---

### 優先度: 低（Phase1-13以降）

#### Phase1-13: 被扶養者管理機能の実装
- 被扶養者情報の型定義とCRUD機能
- 従業員との紐づけ
- 資格取得日・喪失日の管理

#### Phase1-14: 標準報酬決定・改定履歴管理の実装
- 履歴管理機能の実装
- 適用開始年月の管理
- 決定区分の管理

#### Phase1-15: CSVインポート・エクスポート機能の拡張
- 従業員情報のCSVインポート
- 賞与一覧のCSVエクスポート
- エラー行の確認・修正画面

---

## 📝 推奨実装順序

1. **Phase1-9**: 月次保険料一覧機能の拡張（既存機能の改善、ユーザー体験向上）
2. **Phase1-10**: 負担構成ダッシュボード機能の実装（経営判断に役立つ情報提供）
3. **Phase1-11**: セキュリティ・アクセス制御の強化（本番環境に向けた必須機能）
4. **Phase1-12**: 保険料シミュレーション機能の実装（ユーザー体験向上）

---

## 🔍 実装時の注意点

### Phase1-9（月次保険料一覧機能の拡張）
- 過去月分のデータは既にFirestoreに保存されているため、表示のみの実装でOK
- 年月選択UIは`MatSelect`または`MatDatepicker`を使用
- CSVエクスポートは`papaparse`ライブラリを使用するか、手動でCSV形式の文字列を生成

### Phase1-10（負担構成ダッシュボード機能）
- Chart.jsまたはng2-chartsを使用する場合、`package.json`に追加が必要
- 集計ロジックはRxJSの`combineLatest`、`map`、`reduce`を使用
- パフォーマンスを考慮し、必要に応じてキャッシュを実装

### Phase1-11（セキュリティ・アクセス制御）
- Firestoreセキュリティルールは本番環境で必須
- ロール別アクセス制御は`CanActivate`ガードを使用
- 既存のデータアクセスパターンを壊さないように注意

### Phase1-12（保険料シミュレーション機能）
- `premium-calculator.ts`のロジックを再利用
- 一時的な`Employee`オブジェクトを作成して計算
- マスタデータ（保険料率）を取得して計算に使用

---

## 📌 補足事項

- 各フェーズは独立して実装可能ですが、Phase1-9とPhase1-10は連携して実装すると効果的です
- Phase1-11（セキュリティ強化）は本番環境に向けた必須機能ですが、開発環境では後回しにしても問題ありません
- Phase1-12（シミュレーション機能）は既存の計算ロジックを再利用できるため、実装が比較的簡単です

---

以上が次期実装提案です。不明点があれば確認してください。

